<!-- clientintakeform.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Client Intake Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<template id="carbyne_client_intake">
  <style>
    .ci-wrap{
      width:100%;
      max-width:980px;
    }

    .ci-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding:4px 2px 0;
    }

    .ci-h2{
      margin:0;
      font-size:28px;
      font-weight:950;
      color:#0b2f4e;
      letter-spacing:.2px;
    }

    .ci-section{
      margin-top:12px;
      font-size:14px;
      font-weight:950;
      color:#0f172a;
      letter-spacing:.2px;
    }

    .ci-sectionline{
      width:100%;
      height:2px;
      background:#00305B;
      border-radius:999px;
      margin:8px 0 12px;
    }

    .ci-spacer{height:10px}

    .ci-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:14px;
      margin-top:10px;
      width:100%;
    }

    .ci-grid.three{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:14px;
      margin-top:10px;
      width:100%;
    }

    .ci-grid.four{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:14px;
      margin-top:10px;
      width:100%;
    }

    .ci-grid.titlefit{
      grid-template-columns:none;
      grid-auto-flow:column;
      grid-auto-columns:max-content;
      align-items:end;
      width:100%;
      justify-content:space-between;
      column-gap:0;
    }

    .ci-grid.titlefit .ci-label{
      white-space:nowrap;
    }

    .ci-grid.titlefit .ci-field{
      min-width:0;
    }

    .ci-grid.industryaddr{
      grid-template-columns:minmax(0,1fr) minmax(0,1.45fr) minmax(0,.65fr);
    }

    .ci-grid.paycard{
      grid-template-columns: minmax(0,2.4fr) minmax(0,1fr) minmax(0,.55fr) minmax(0,.55fr);
    }

    .ci-field{width:100%}

    .ci-wide{grid-column:1 / -1}

    .ci-labelrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 8px;
    }

    .ci-label{
      font-size:13px;
      font-weight:950;
      color:#0f172a;
      opacity:.92;
    }

    .ci-inline{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      font-weight:950;
      color:#0f172a;
      opacity:.85;
      white-space:nowrap;
    }

    .ci-check{
      width:16px;height:16px;
      accent-color:#00305B;
      cursor:pointer;
    }

    .ci-input, .ci-select{
      width:100%;
      border:1px solid rgba(0,0,0,.14);
      border-radius:14px;
      padding:14px 16px;
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
      transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease, opacity .18s ease;
      color:#0f172a;
    }

    .ci-input::placeholder{color:#64748b;font-weight:900;opacity:.75}

    .ci-input:focus, .ci-select:focus{
      border-color:rgba(0,48,91,.70);
      box-shadow:0 0 0 3px rgba(0,48,91,.16), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.6;
    }
    .ci-input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    .ci-input:disabled{
      background:#f1f5f9;
      color:#64748b;
      box-shadow:none;
      opacity:.95;
      cursor:not-allowed;
    }

    /* Basis of Accounting */
    .ci-basis-row{
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:nowrap;
      margin-top:10px;
      padding:2px 2px 0;
      width:100%;
    }

    .ci-radio{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      font-weight:950;
      color:#0f172a;
      opacity:.92;
      white-space:nowrap;
      user-select:none;
      flex:0 0 auto;
    }

    .ci-radio input[type="radio"]{
      width:16px;height:16px;
      accent-color:#00305B;
      cursor:pointer;
      flex:0 0 auto;
    }

    .ci-other-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1 1 auto;
      min-width:220px;
    }

    .ci-other-input{
      flex:1 1 auto;
      width:100%;
      min-width:0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.14);
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
      transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease, opacity .18s ease;
      color:#0f172a;
    }

    .ci-other-input::placeholder{color:#64748b;font-weight:900;opacity:.75}

    .ci-other-input:focus{
      border-color:rgba(0,48,91,.70);
      box-shadow:0 0 0 3px rgba(0,48,91,.16), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-other-input:disabled{
      background:#f1f5f9;
      color:#64748b;
      box-shadow:none;
      opacity:.95;
      cursor:not-allowed;
    }

    /* Payment notice */
    .ci-note{
      width:100%;
      border:1px solid rgba(0,48,91,.18);
      background:rgba(0,48,91,.06);
      border-radius:14px;
      padding:12px 14px;
      color:#0f172a;
      font-size:13px;
      font-weight:900;
      line-height:1.35;
      box-shadow:0 10px 20px rgba(2,6,23,.06);
      margin-top:2px;
    }

    @media (max-width:820px){
      .ci-grid, .ci-grid.three, .ci-grid.four{grid-template-columns:1fr}
      .ci-grid.paycard{grid-template-columns:1fr}
      .ci-grid.titlefit{
        grid-auto-flow:row;
        grid-auto-columns:unset;
        justify-content:stretch;
        column-gap:0;
      }
      .ci-grid.titlefit .ci-label{
        white-space:normal;
      }
      .ci-basis-row{flex-wrap:wrap}
      .ci-other-wrap{flex:1 1 100%}
    }
  </style>

  <div class="ci-wrap" id="ciRoot">
    <div class="ci-top">
      <h2 class="ci-h2">Client Intake Form</h2>
      <div></div>
    </div>

    <div class="ci-spacer"></div>

    <div class="ci-section">Business Information</div>
    <div class="ci-sectionline"></div>

    <div class="ci-grid">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Name of Business</div>
        </div>
        <input class="ci-input" id="bi_name" type="text" placeholder="Name of Business" autocomplete="organization">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Employer Identification Number (EIN)</div>
          <label class="ci-inline">
            <input class="ci-check" id="bi_no_fein" type="checkbox">
            No EIN
          </label>
        </div>
        <input class="ci-input" id="bi_fein" type="text" placeholder="XX-XXXXXXX" inputmode="numeric" autocomplete="off" maxlength="10">
      </div>
    </div>

    <div class="ci-grid three titlefit" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Formation Date</div>
        </div>
        <input class="ci-input" id="bi_formation_date" type="date" autocomplete="off">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Full Name of Person Completing this Agreement</div>
        </div>
        <input class="ci-input" id="bi_fullname" type="text" placeholder="Full Name" autocomplete="name">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Title</div>
        </div>
        <input class="ci-input" id="bi_title" type="text" placeholder="Title" autocomplete="organization-title">
      </div>
    </div>

    <div class="ci-grid three industryaddr" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Industry</div>
        </div>
        <input class="ci-input" id="bi_industry" type="text" placeholder="Business Industry" autocomplete="organization">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Address</div>
        </div>
        <input class="ci-input" id="bi_address" type="text" placeholder="Business Address" autocomplete="street-address">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Suite / Unit Number</div>
        </div>
        <input class="ci-input" id="bi_suite" type="text" placeholder="Suite / Unit Number" autocomplete="address-line2">
      </div>
    </div>

    <div class="ci-grid three" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">City</div>
        </div>
        <input class="ci-input" id="bi_city" type="text" placeholder="City" autocomplete="address-level2">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">State</div>
        </div>
        <select class="ci-select" id="bi_state" autocomplete="address-level1">
          <option value="" selected>Select</option>
          <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
          <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
          <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
          <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
          <option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
          <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
          <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
          <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
          <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
          <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
          <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option>
          <option value="UT">UT</option><option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option>
          <option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
        </select>
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Zip Code</div>
        </div>
        <input class="ci-input" id="bi_zip" type="text" placeholder="Zip Code" inputmode="numeric" autocomplete="postal-code" maxlength="10">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Phone Number</div>
        </div>
        <input class="ci-input" id="bi_phone" type="tel" placeholder="(XXX) XXX-XXXX" inputmode="numeric" autocomplete="tel" maxlength="14">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Email Address</div>
        </div>
        <input class="ci-input" id="bi_email" type="email" placeholder="Business Email Address" autocomplete="email">
      </div>
    </div>

    <div class="ci-grid three" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Point of Contact (POC)</div>
        </div>
        <input class="ci-input" id="bi_poc" type="text" placeholder="Point of Contact" autocomplete="name">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">POC Email</div>
        </div>
        <input class="ci-input" id="poc_email" type="email" placeholder="POC Email" autocomplete="email">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">POC Phone Number</div>
        </div>
        <input class="ci-input" id="poc_phone" type="tel" placeholder="(XXX) XXX-XXXX" inputmode="numeric" autocomplete="tel" maxlength="14">
      </div>
    </div>

    <div class="ci-section" style="margin-top:18px;">Accounting Information</div>
    <div class="ci-sectionline"></div>

    <div class="ci-grid" style="margin-top:0;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Basis of Accounting</div>
        </div>
      </div>
    </div>

    <div class="ci-basis-row" role="group" aria-label="Basis of Accounting" style="margin-top:0;">
      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_accrual" value="Accrual Basis">
        Accrual Basis
      </label>

      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_cash" value="Cash Basis">
        Cash Basis
      </label>

      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_mixed" value="Mixed Method">
        Mixed Method
      </label>

      <div class="ci-other-wrap">
        <label class="ci-radio">
          <input type="radio" name="boa_basis" id="boa_other" value="Other">
          Other
        </label>
        <input class="ci-other-input" id="boa_other_text" type="text" placeholder="Specify" autocomplete="off" disabled>
      </div>
    </div>

    <div class="ci-grid" style="margin-top:16px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Do you have another accountant?</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Do you have another accountant?" style="margin-top:0;">
          <label class="ci-radio">
            <input type="radio" name="ai_other_accountant" id="ai_other_acct_yes" value="Yes">
            Yes
          </label>

          <label class="ci-radio">
            <input type="radio" name="ai_other_accountant" id="ai_other_acct_no" value="No">
            No
          </label>
        </div>
      </div>
    </div>

    <div class="ci-grid three" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Accountant Name</div>
        </div>
        <input class="ci-input" id="ai_accountant_name" type="text" placeholder="Accountant Name" autocomplete="name" disabled>
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Phone Number</div>
        </div>
        <input class="ci-input" id="ai_accountant_phone" type="tel" placeholder="(XXX) XXX-XXXX" inputmode="numeric" autocomplete="tel" maxlength="14" disabled>
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Email Address</div>
        </div>
        <input class="ci-input" id="ai_accountant_email" type="email" placeholder="Email Address" autocomplete="email" disabled>
      </div>
    </div>

    <div class="ci-grid" style="margin-top:16px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Do you currently use an accounting software?</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Do you currently use an accounting software?" style="margin-top:0;">
          <label class="ci-radio">
            <input type="radio" name="ai_use_accounting_software" id="ai_sw_yes" value="Yes">
            Yes
          </label>

          <label class="ci-radio">
            <input type="radio" name="ai_use_accounting_software" id="ai_sw_no" value="No">
            No
          </label>

          <div class="ci-other-wrap" style="min-width:320px;">
            <div class="ci-label" style="font-size:13px;font-weight:950;opacity:.92;white-space:nowrap;">If yes, specify</div>
            <input class="ci-other-input" id="ai_sw_specify" type="text" placeholder="Accounting Software" autocomplete="off" disabled>
          </div>
        </div>
      </div>
    </div>

    <div class="ci-grid" style="margin-top:16px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Do you have accounting records for the full life of the business?</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Do you have accounting records for the full life of the business?" style="margin-top:0;">
          <label class="ci-radio">
            <input type="radio" name="ai_records_full_history" id="ai_records_yes" value="Yes">
            Yes
          </label>

          <label class="ci-radio">
            <input type="radio" name="ai_records_full_history" id="ai_records_no" value="No">
            No
          </label>
        </div>
      </div>
    </div>

    <div class="ci-section" style="margin-top:18px;">Payment Information</div>
    <div class="ci-sectionline"></div>

    <div class="ci-note" id="pay_notice">
      Payment not charged at this time. Payment information collected for payment-related onboarding agreements.
    </div>

    <div class="ci-grid" style="margin-top:12px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">We require all clients to keep a debit or credit card on file. Please fill out the following:</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Card Type" style="margin-top:0;">
          <label class="ci-radio">
            <input type="radio" name="pay_card_type" id="pay_card_mc" value="Mastercard">
            Mastercard
          </label>

          <label class="ci-radio">
            <input type="radio" name="pay_card_type" id="pay_card_visa" value="Visa">
            Visa
          </label>

          <label class="ci-radio">
            <input type="radio" name="pay_card_type" id="pay_card_amex" value="American Express">
            American Express
          </label>

          <label class="ci-radio">
            <input type="radio" name="pay_card_type" id="pay_card_disc" value="Discover">
            Discover
          </label>
        </div>
      </div>
    </div>

    <div class="ci-grid paycard" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Card Number</div>
        </div>
        <input class="ci-input" id="pay_card_number" type="text" placeholder="XXXX XXXX XXXX XXXX" inputmode="numeric" autocomplete="cc-number" maxlength="19">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Expiration Date</div>
        </div>
        <input class="ci-input" id="pay_card_exp" type="text" placeholder="MM/YY" inputmode="numeric" autocomplete="cc-exp" maxlength="5">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">CVV</div>
        </div>
        <input class="ci-input" id="pay_card_cvv" type="text" placeholder="CVV" inputmode="numeric" autocomplete="cc-csc" maxlength="4">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Zip Code</div>
        </div>
        <input class="ci-input" id="pay_card_zip" type="text" placeholder="Zip Code" inputmode="numeric" autocomplete="postal-code" maxlength="10">
      </div>
    </div>

  </div>
</template>

<script>
  (function(){
    const STORAGE_KEY_INTAKE = "carbyne_intake_business_info";

    function onlyDigits(s){ return (s || "").replace(/\D/g,""); }

    function formatPhone(raw){
      const d = onlyDigits(raw).slice(0,10);
      const a = d.slice(0,3);
      const b = d.slice(3,6);
      const c = d.slice(6,10);
      if (!d) return "";
      if (d.length <= 3) return "(" + a;
      if (d.length <= 6) return "(" + a + ") " + b;
      return "(" + a + ") " + b + "-" + c;
    }

    function formatFein(raw){
      const d = onlyDigits(raw).slice(0,9);
      if (!d) return "";
      if (d.length <= 2) return d;
      return d.slice(0,2) + "-" + d.slice(2);
    }

    function formatZip(raw){
      const d = onlyDigits(raw).slice(0,9);
      if (!d) return "";
      if (d.length <= 5) return d;
      return d.slice(0,5) + "-" + d.slice(5);
    }

    function getSelectedValue(root, name){
      const sel = root.querySelector('input[type="radio"][name="'+name+'"]:checked');
      return sel ? (sel.value || "") : "";
    }

    function formatCardNumber(raw, cardType){
      const d = onlyDigits(raw);
      if (cardType === "American Express"){
        const x = d.slice(0,15);
        const p1 = x.slice(0,4);
        const p2 = x.slice(4,10);
        const p3 = x.slice(10,15);
        if (!x) return "";
        if (x.length <= 4) return p1;
        if (x.length <= 10) return p1 + " " + p2;
        return p1 + " " + p2 + " " + p3;
      } else {
        const x = d.slice(0,16);
        const parts = [];
        for (let i=0;i<x.length;i+=4){
          parts.push(x.slice(i,i+4));
        }
        return parts.join(" ");
      }
    }

    function formatExp(raw){
      const d = onlyDigits(raw).slice(0,4);
      if (!d) return "";
      if (d.length <= 2) return d;
      return d.slice(0,2) + "/" + d.slice(2);
    }

    function maxCvvLen(cardType){
      return (cardType === "American Express") ? 4 : 3;
    }

    function loadSaved(root){
      try{
        const raw = localStorage.getItem(STORAGE_KEY_INTAKE);
        if (!raw) return;
        const data = JSON.parse(raw);

        const ids = [
          "bi_name","bi_fein","bi_formation_date","bi_fullname","bi_title",
          "bi_industry","bi_address","bi_suite",
          "bi_city","bi_state","bi_zip","bi_phone","bi_email","bi_poc",
          "poc_email","poc_phone",
          "boa_other_text",
          "ai_accountant_name","ai_accountant_phone","ai_accountant_email",
          "ai_sw_specify",
          "pay_card_number","pay_card_exp","pay_card_cvv","pay_card_zip"
        ];

        ids.forEach(id=>{
          const el = root.querySelector("#"+id);
          if (!el) return;
          el.value = (data[id] ?? "");
        });

        const cb = root.querySelector("#bi_no_fein");
        if (cb){
          cb.checked = !!data["bi_no_fein"];
        }

        const savedBasis = (data["boa_basis"] ?? "");
        if (savedBasis){
          const radios = Array.from(root.querySelectorAll('input[type="radio"][name="boa_basis"]'));
          radios.forEach(r=>{ r.checked = (r.value === savedBasis); });
        }

        const savedOtherAcct = (data["ai_other_accountant"] ?? "");
        if (savedOtherAcct){
          const radios2 = Array.from(root.querySelectorAll('input[type="radio"][name="ai_other_accountant"]'));
          radios2.forEach(r=>{ r.checked = (r.value === savedOtherAcct); });
        }

        const savedUseSw = (data["ai_use_accounting_software"] ?? "");
        if (savedUseSw){
          const radios3 = Array.from(root.querySelectorAll('input[type="radio"][name="ai_use_accounting_software"]'));
          radios3.forEach(r=>{ r.checked = (r.value === savedUseSw); });
        }

        const savedRecords = (data["ai_records_full_history"] ?? "");
        if (savedRecords){
          const radios4 = Array.from(root.querySelectorAll('input[type="radio"][name="ai_records_full_history"]'));
          radios4.forEach(r=>{ r.checked = (r.value === savedRecords); });
        }

        const savedCardType = (data["pay_card_type"] ?? "");
        if (savedCardType){
          const radios5 = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_type"]'));
          radios5.forEach(r=>{ r.checked = (r.value === savedCardType); });
        }
      } catch {}
    }

    function save(root){
      const out = {};
      const ids = [
        "bi_name","bi_fein","bi_formation_date","bi_fullname","bi_title",
        "bi_industry","bi_address","bi_suite",
        "bi_city","bi_state","bi_zip","bi_phone","bi_email","bi_poc",
        "poc_email","poc_phone",
        "ai_accountant_name","ai_accountant_phone","ai_accountant_email",
        "ai_sw_specify",
        "pay_card_number","pay_card_exp","pay_card_cvv","pay_card_zip"
      ];
      ids.forEach(id=>{
        const el = root.querySelector("#"+id);
        if (!el) return;
        out[id] = el.value || "";
      });

      const cb = root.querySelector("#bi_no_fein");
      out["bi_no_fein"] = cb ? !!cb.checked : false;

      out["boa_basis"] = getSelectedValue(root, "boa_basis");
      const otherText = root.querySelector("#boa_other_text");
      out["boa_other_text"] = otherText ? (otherText.value || "") : "";

      out["ai_other_accountant"] = getSelectedValue(root, "ai_other_accountant");
      out["ai_use_accounting_software"] = getSelectedValue(root, "ai_use_accounting_software");
      out["ai_records_full_history"] = getSelectedValue(root, "ai_records_full_history");

      out["pay_card_type"] = getSelectedValue(root, "pay_card_type");

      try{ localStorage.setItem(STORAGE_KEY_INTAKE, JSON.stringify(out)); } catch {}
    }

    window.carbyne_client_intake_mount = function(args){
      const root = args && args.root ? args.root : document;
      const fein = root.querySelector("#bi_fein");
      const noFein = root.querySelector("#bi_no_fein");
      const phone = root.querySelector("#bi_phone");
      const zip = root.querySelector("#bi_zip");

      const pocPhone = root.querySelector("#poc_phone");
      const acctPhone = root.querySelector("#ai_accountant_phone");

      const boaOtherRadio = root.querySelector("#boa_other");
      const boaOtherText = root.querySelector("#boa_other_text");
      const boaRadios = Array.from(root.querySelectorAll('input[type="radio"][name="boa_basis"]'));

      const otherAcctRadios = Array.from(root.querySelectorAll('input[type="radio"][name="ai_other_accountant"]'));
      const otherAcctYes = root.querySelector("#ai_other_acct_yes");

      const acctName = root.querySelector("#ai_accountant_name");
      const acctEmail = root.querySelector("#ai_accountant_email");

      const useSwRadios = Array.from(root.querySelectorAll('input[type="radio"][name="ai_use_accounting_software"]'));
      const useSwYes = root.querySelector("#ai_sw_yes");
      const swSpecify = root.querySelector("#ai_sw_specify");

      const payCardTypeRadios = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_type"]'));
      const payCardNumber = root.querySelector("#pay_card_number");
      const payCardExp = root.querySelector("#pay_card_exp");
      const payCardCvv = root.querySelector("#pay_card_cvv");
      const payCardZip = root.querySelector("#pay_card_zip");

      loadSaved(root);

      const onFeinInput = () => {
        if (!fein) return;
        if (noFein && noFein.checked) return;
        fein.value = (function(raw){
          const d = onlyDigits(raw).slice(0,9);
          if (!d) return "";
          if (d.length <= 2) return d;
          return d.slice(0,2) + "-" + d.slice(2);
        })(fein.value);
        save(root);
      };

      const onNoFeinToggle = () => {
        if (!fein || !noFein) return;
        if (noFein.checked){
          fein.value = "Unavailable";
          fein.setAttribute("readonly","readonly");
        } else {
          fein.removeAttribute("readonly");
          fein.value = "";
        }
        save(root);
      };

      const onPhoneInput = () => {
        if (!phone) return;
        phone.value = formatPhone(phone.value);
        save(root);
      };

      const onPocPhoneInput = () => {
        if (!pocPhone) return;
        pocPhone.value = formatPhone(pocPhone.value);
        save(root);
      };

      const onAcctPhoneInput = () => {
        if (!acctPhone) return;
        acctPhone.value = formatPhone(acctPhone.value);
        save(root);
      };

      const onZipInput = () => {
        if (!zip) return;
        zip.value = formatZip(zip.value);
        save(root);
      };

      const onPayZipInput = () => {
        if (!payCardZip) return;
        payCardZip.value = formatZip(payCardZip.value);
        save(root);
      };

      function syncOtherState(){
        if (!boaOtherText) return;
        const active = !!(boaOtherRadio && boaOtherRadio.checked);
        if (active){
          boaOtherText.disabled = false;
        } else {
          boaOtherText.disabled = true;
          boaOtherText.value = "";
        }
        save(root);
      }

      function syncOtherAccountantState(){
        const yes = !!(otherAcctYes && otherAcctYes.checked);

        if (acctName) acctName.disabled = !yes;
        if (acctPhone) acctPhone.disabled = !yes;
        if (acctEmail) acctEmail.disabled = !yes;

        if (!yes){
          if (acctName) acctName.value = "";
          if (acctPhone) acctPhone.value = "";
          if (acctEmail) acctEmail.value = "";
        }
        save(root);
      }

      function syncAccountingSoftwareState(){
        if (!swSpecify) return;
        const yes = !!(useSwYes && useSwYes.checked);
        if (yes){
          swSpecify.disabled = false;
        } else {
          swSpecify.disabled = true;
          swSpecify.value = "";
        }
        save(root);
      }

      function syncCardFormat(){
        const cardType = getSelectedValue(root, "pay_card_type");
        if (payCardNumber){
          if (cardType === "American Express"){
            payCardNumber.setAttribute("maxlength","17");
            payCardNumber.placeholder = "XXXX XXXXXX XXXXX";
          } else {
            payCardNumber.setAttribute("maxlength","19");
            payCardNumber.placeholder = "XXXX XXXX XXXX XXXX";
          }
          payCardNumber.value = formatCardNumber(payCardNumber.value, cardType);
        }

        if (payCardCvv){
          const maxLen = maxCvvLen(cardType);
          payCardCvv.setAttribute("maxlength", String(maxLen));
          payCardCvv.placeholder = (maxLen === 4) ? "4-digit CVV" : "3-digit CVV";
          payCardCvv.value = onlyDigits(payCardCvv.value).slice(0, maxLen);
        }

        save(root);
      }

      const onPayCardNumberInput = () => {
        if (!payCardNumber) return;
        const cardType = getSelectedValue(root, "pay_card_type");
        payCardNumber.value = formatCardNumber(payCardNumber.value, cardType);
        save(root);
      };

      const onPayExpInput = () => {
        if (!payCardExp) return;
        payCardExp.value = formatExp(payCardExp.value);
        save(root);
      };

      const onPayCvvInput = () => {
        if (!payCardCvv) return;
        const cardType = getSelectedValue(root, "pay_card_type");
        const maxLen = maxCvvLen(cardType);
        payCardCvv.value = onlyDigits(payCardCvv.value).slice(0, maxLen);
        save(root);
      };

      const onAnyChange = () => save(root);

      const onBasisChange = () => syncOtherState();
      const onOtherAcctChange = () => syncOtherAccountantState();
      const onUseSwChange = () => syncAccountingSoftwareState();
      const onCardTypeChange = () => syncCardFormat();
      const onOtherTextInput = () => { if (!boaOtherText) return; save(root); };

      if (fein){
        fein.addEventListener("input", onFeinInput);
        fein.addEventListener("blur", onFeinInput);
      }
      if (noFein){
        noFein.addEventListener("change", onNoFeinToggle);
        onNoFeinToggle();
      }
      if (phone){
        phone.addEventListener("input", onPhoneInput);
        phone.addEventListener("blur", onPhoneInput);
      }
      if (pocPhone){
        pocPhone.addEventListener("input", onPocPhoneInput);
        pocPhone.addEventListener("blur", onPocPhoneInput);
      }
      if (acctPhone){
        acctPhone.addEventListener("input", onAcctPhoneInput);
        acctPhone.addEventListener("blur", onAcctPhoneInput);
      }
      if (zip){
        zip.addEventListener("input", onZipInput);
        zip.addEventListener("blur", onZipInput);
      }

      boaRadios.forEach(r=>{ r.addEventListener("change", onBasisChange); });

      if (boaOtherText){
        boaOtherText.addEventListener("input", onOtherTextInput);
        boaOtherText.addEventListener("change", onOtherTextInput);
        boaOtherText.addEventListener("blur", onOtherTextInput);
      }

      otherAcctRadios.forEach(r=>{ r.addEventListener("change", onOtherAcctChange); });
      useSwRadios.forEach(r=>{ r.addEventListener("change", onUseSwChange); });

      if (swSpecify){
        swSpecify.addEventListener("input", onAnyChange);
        swSpecify.addEventListener("change", onAnyChange);
        swSpecify.addEventListener("blur", onAnyChange);
      }

      payCardTypeRadios.forEach(r=>{ r.addEventListener("change", onCardTypeChange); });

      if (payCardNumber){
        payCardNumber.addEventListener("input", onPayCardNumberInput);
        payCardNumber.addEventListener("blur", onPayCardNumberInput);
      }
      if (payCardExp){
        payCardExp.addEventListener("input", onPayExpInput);
        payCardExp.addEventListener("blur", onPayExpInput);
      }
      if (payCardCvv){
        payCardCvv.addEventListener("input", onPayCvvInput);
        payCardCvv.addEventListener("blur", onPayCvvInput);
      }
      if (payCardZip){
        payCardZip.addEventListener("input", onPayZipInput);
        payCardZip.addEventListener("blur", onPayZipInput);
      }

      syncOtherState();
      syncOtherAccountantState();
      syncAccountingSoftwareState();
      syncCardFormat();

      const allInputs = Array.from(root.querySelectorAll("input,select"));
      allInputs.forEach(el=>{
        if (el.id === "bi_fein" || el.id === "bi_phone" || el.id === "poc_phone" || el.id === "ai_accountant_phone" || el.id === "bi_zip" || el.id === "bi_no_fein") return;
        if (el.name === "boa_basis" || el.id === "boa_other_text") return;
        if (el.name === "ai_other_accountant") return;
        if (el.name === "ai_use_accounting_software") return;
        if (el.id === "ai_sw_specify") return;

        if (el.name === "pay_card_type") return;
        if (el.id === "pay_card_number" || el.id === "pay_card_exp" || el.id === "pay_card_cvv" || el.id === "pay_card_zip") return;

        el.addEventListener("input", onAnyChange);
        el.addEventListener("change", onAnyChange);
        el.addEventListener("blur", onAnyChange);
      });

      return function unmount(){
        if (fein){
          fein.removeEventListener("input", onFeinInput);
          fein.removeEventListener("blur", onFeinInput);
        }
        if (noFein){
          noFein.removeEventListener("change", onNoFeinToggle);
        }
        if (phone){
          phone.removeEventListener("input", onPhoneInput);
          phone.removeEventListener("blur", onPhoneInput);
        }
        if (pocPhone){
          pocPhone.removeEventListener("input", onPocPhoneInput);
          pocPhone.removeEventListener("blur", onPocPhoneInput);
        }
        if (acctPhone){
          acctPhone.removeEventListener("input", onAcctPhoneInput);
          acctPhone.removeEventListener("blur", onAcctPhoneInput);
        }
        if (zip){
          zip.removeEventListener("input", onZipInput);
          zip.removeEventListener("blur", onZipInput);
        }

        boaRadios.forEach(r=>{ r.removeEventListener("change", onBasisChange); });

        if (boaOtherText){
          boaOtherText.removeEventListener("input", onOtherTextInput);
          boaOtherText.removeEventListener("change", onOtherTextInput);
          boaOtherText.removeEventListener("blur", onOtherTextInput);
        }

        otherAcctRadios.forEach(r=>{ r.removeEventListener("change", onOtherAcctChange); });
        useSwRadios.forEach(r=>{ r.removeEventListener("change", onUseSwChange); });

        if (swSpecify){
          swSpecify.removeEventListener("input", onAnyChange);
          swSpecify.removeEventListener("change", onAnyChange);
          swSpecify.removeEventListener("blur", onAnyChange);
        }

        payCardTypeRadios.forEach(r=>{ r.removeEventListener("change", onCardTypeChange); });

        if (payCardNumber){
          payCardNumber.removeEventListener("input", onPayCardNumberInput);
          payCardNumber.removeEventListener("blur", onPayCardNumberInput);
        }
        if (payCardExp){
          payCardExp.removeEventListener("input", onPayExpInput);
          payCardExp.removeEventListener("blur", onPayExpInput);
        }
        if (payCardCvv){
          payCardCvv.removeEventListener("input", onPayCvvInput);
          payCardCvv.removeEventListener("blur", onPayCvvInput);
        }
        if (payCardZip){
          payCardZip.removeEventListener("input", onPayZipInput);
          payCardZip.removeEventListener("blur", onPayZipInput);
        }

        allInputs.forEach(el=>{
          el.removeEventListener("input", onAnyChange);
          el.removeEventListener("change", onAnyChange);
          el.removeEventListener("blur", onAnyChange);
        });
      };
    };
  })();
</script>

</body>
</html>
