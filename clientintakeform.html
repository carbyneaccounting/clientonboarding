<!-- clientintakeform.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Client Intake Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<template id="carbyne_client_intake">
  <style>
    .ci-wrap{
      width:100%;
      max-width:980px;
    }

    .ci-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding:4px 2px 0;
    }

    .ci-h2{
      margin:0;
      font-size:28px;
      font-weight:950;
      color:#0b2f4e;
      letter-spacing:.2px;
    }

    .ci-section{
      margin-top:12px;
      font-size:14px;
      font-weight:950;
      color:#0f172a;
      letter-spacing:.2px;
    }

    .ci-sectionline{
      width:100%;
      height:2px;
      background:#00305B;
      border-radius:999px;
      margin:8px 0 12px;
    }

    .ci-spacer{height:10px}

    .ci-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:14px;
      margin-top:10px;
      width:100%;
    }

    .ci-grid.three{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:14px;
      margin-top:10px;
      width:100%;
    }

    .ci-grid.four{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:14px;
      margin-top:10px;
      width:100%;
    }

    .ci-grid.titlefit{
      grid-template-columns:none;
      grid-auto-flow:column;
      grid-auto-columns:max-content;
      align-items:end;
      width:100%;
      justify-content:space-between;
      column-gap:0;
    }

    .ci-grid.titlefit .ci-label{
      white-space:nowrap;
    }

    .ci-grid.titlefit .ci-field{
      min-width:0;
    }

    .ci-grid.industryaddr{
      grid-template-columns:minmax(0,1fr) minmax(0,1.45fr) minmax(0,.65fr);
    }

    .ci-grid.paycard{
      grid-template-columns: minmax(0,2.05fr) minmax(0,1.25fr) minmax(0,.85fr) minmax(0,.85fr);
    }

    .ci-grid.paymeta{
      column-gap:10px;
      row-gap:0px;
      margin-top:14px;
    }

    .ci-field{width:100%}
    .ci-wide{grid-column:1 / -1}

    .ci-labelrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 8px;
    }

    .ci-label{
      font-size:13px;
      font-weight:950;
      color:#0f172a;
      opacity:.92;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .ci-req{
      color:#b91c1c;
      font-weight:950;
      margin-left:2px;
      line-height:1;
    }

    .ci-inline{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      font-weight:950;
      color:#0f172a;
      opacity:.85;
      white-space:nowrap;
    }

    .ci-check{
      width:16px;height:16px;
      accent-color:#00305B;
      cursor:pointer;
    }

    .ci-input, .ci-select{
      width:100%;
      border:1px solid rgba(0,0,0,.14);
      border-radius:14px;
      padding:14px 16px;
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
      transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease, opacity .18s ease;
      color:#0f172a;
    }

    .ci-input::placeholder{color:#64748b;font-weight:900;opacity:.75}

    .ci-input:focus, .ci-select:focus{
      border-color:rgba(0,48,91,.70);
      box-shadow:0 0 0 3px rgba(0,48,91,.16), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.6;
    }
    .ci-input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    .ci-input:disabled, .ci-select:disabled{
      background:#f1f5f9;
      color:#64748b;
      box-shadow:none;
      opacity:.95;
      cursor:not-allowed;
    }

    .ci-input.ci-invalid{
      border-color:rgba(185,28,28,.65);
      box-shadow:0 0 0 3px rgba(185,28,28,.10), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-hint{
      font-size:12px;
      font-weight:950;
      color:#0f172a;
      opacity:.75;
      white-space:nowrap;
    }

    .ci-hint.bad{
      color:#b91c1c;
      opacity:1;
    }

    .ci-input.ci-error, .ci-select.ci-error{
      border-color:rgba(185,28,28,.65);
      box-shadow:0 0 0 3px rgba(185,28,28,.10), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-basis-row{
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:nowrap;
      margin-top:10px;
      padding:2px 2px 0;
      width:100%;
    }

    .ci-basis-row.tight{
      gap:12px;
    }

    .ci-radio{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      font-weight:950;
      color:#0f172a;
      opacity:.92;
      white-space:nowrap;
      user-select:none;
      flex:0 0 auto;
    }

    .ci-radio input[type="radio"]{
      width:16px;height:16px;
      accent-color:#00305B;
      cursor:pointer;
      flex:0 0 auto;
    }

    .ci-other-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1 1 auto;
      min-width:220px;
    }

    .ci-other-input{
      flex:1 1 auto;
      width:100%;
      min-width:0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.14);
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
      transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease, opacity .18s ease;
      color:#0f172a;
    }

    .ci-other-input::placeholder{color:#64748b;font-weight:900;opacity:.75}

    .ci-other-input:focus{
      border-color:rgba(0,48,91,.70);
      box-shadow:0 0 0 3px rgba(0,48,91,.16), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-other-input:disabled{
      background:#f1f5f9;
      color:#64748b;
      box-shadow:none;
      opacity:.95;
      cursor:not-allowed;
    }

    .ci-note{
      width:100%;
      border:1px solid rgba(0,48,91,.18);
      background:rgba(0,48,91,.06);
      border-radius:14px;
      padding:12px 14px;
      color:#0f172a;
      font-size:13px;
      font-weight:900;
      line-height:1.35;
      box-shadow:0 10px 20px rgba(2,6,23,.06);
      margin-top:2px;
    }

    .ci-actions{
      width:100%;
      display:flex;
      justify-content:flex-start;
      margin-top:12px;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .ci-submitline{
      width:100%;
      height:2px;
      background:#00305B;
      border-radius:999px;
      margin:18px 0 12px;
    }

    .ci-submit{
      appearance:none;
      border:0;
      border-radius:14px;
      padding:14px 18px;
      font-size:14px;
      font-weight:950;
      letter-spacing:.2px;
      background:#00305B;
      color:#fff;
      cursor:pointer;
      box-shadow:0 10px 20px rgba(2,6,23,.10);
      transition:transform .14s ease, opacity .14s ease, box-shadow .14s ease;
    }

    .ci-submit:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(2,6,23,.14);
    }

    .ci-submit:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:0 10px 20px rgba(2,6,23,.06);
    }

    .ci-submit-msg{
      display:none;
      font-size:13px;
      font-weight:950;
      color:#b91c1c;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .ci-submit-msg.show{display:inline}

    @media (max-width:820px){
      .ci-grid, .ci-grid.three, .ci-grid.four{grid-template-columns:1fr}
      .ci-grid.paycard{grid-template-columns:1fr}
      .ci-grid.titlefit{
        grid-auto-flow:row;
        grid-auto-columns:unset;
        justify-content:stretch;
        column-gap:0;
      }
      .ci-grid.titlefit .ci-label{
        white-space:normal;
      }
      .ci-basis-row{flex-wrap:wrap}
      .ci-other-wrap{flex:1 1 100%}
      .ci-hint{white-space:normal}
      .ci-actions{justify-content:stretch}
      .ci-submit{width:100%}
      .ci-submit-msg{white-space:normal}
    }
  </style>

  <div class="ci-wrap" id="ciRoot">
    <div class="ci-top">
      <h2 class="ci-h2">Client Intake Form</h2>
      <div></div>
    </div>

    <div class="ci-spacer"></div>

    <div class="ci-section">Business Information</div>
    <div class="ci-sectionline"></div>

    <div class="ci-grid">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Name of Business</div>
        </div>
        <input class="ci-input" id="bi_name" type="text" placeholder="Name of Business" autocomplete="organization" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Employer Identification Number (EIN)</div>
          <label class="ci-inline">
            <input class="ci-check" id="bi_no_fein" type="checkbox">
            No EIN
          </label>
        </div>
        <input class="ci-input" id="bi_fein" type="text" placeholder="XX-XXXXXXX" inputmode="numeric" autocomplete="off" maxlength="10" data-required="true">
      </div>
    </div>

    <div class="ci-grid three titlefit" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Formation Date</div>
        </div>
        <input class="ci-input" id="bi_formation_date" type="date" autocomplete="off" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Full Name of Person Completing this Agreement</div>
        </div>
        <input class="ci-input" id="bi_fullname" type="text" placeholder="Full Name" autocomplete="name" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Title</div>
        </div>
        <input class="ci-input" id="bi_title" type="text" placeholder="Title" autocomplete="organization-title" data-required="true">
      </div>
    </div>

    <div class="ci-grid three industryaddr" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Industry</div>
        </div>
        <input class="ci-input" id="bi_industry" type="text" placeholder="Business Industry" autocomplete="organization" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Address</div>
        </div>
        <input class="ci-input" id="bi_address" type="text" placeholder="Business Address" autocomplete="street-address" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Suite / Unit Number</div>
        </div>
        <input class="ci-input" id="bi_suite" type="text" placeholder="Suite / Unit Number" autocomplete="address-line2">
      </div>
    </div>

    <div class="ci-grid three" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">City</div>
        </div>
        <input class="ci-input" id="bi_city" type="text" placeholder="City" autocomplete="address-level2" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">State</div>
        </div>
        <select class="ci-select" id="bi_state" autocomplete="address-level1" data-required="true">
          <option value="" selected>Select</option>
          <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
          <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
          <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
          <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
          <option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
          <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
          <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
          <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
          <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
          <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
          <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
          <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
          <option value="WI">WI</option><option value="WY">WY</option>
        </select>
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Zip Code</div>
        </div>
        <input class="ci-input" id="bi_zip" type="text" placeholder="Zip Code" inputmode="numeric" autocomplete="postal-code" maxlength="10" data-required="true">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Phone Number</div>
        </div>
        <input class="ci-input" id="bi_phone" type="tel" placeholder="(XXX) XXX-XXXX" inputmode="numeric" autocomplete="tel" maxlength="14" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Email Address</div>
        </div>
        <input class="ci-input" id="bi_email" type="email" placeholder="Business Email Address" autocomplete="email" data-required="true">
      </div>
    </div>

    <div class="ci-grid three" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Point of Contact (POC)</div>
        </div>
        <input class="ci-input" id="bi_poc" type="text" placeholder="Point of Contact" autocomplete="name" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">POC Email</div>
        </div>
        <input class="ci-input" id="poc_email" type="email" placeholder="POC Email" autocomplete="email" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">POC Phone Number</div>
        </div>
        <input class="ci-input" id="poc_phone" type="tel" placeholder="(XXX) XXX-XXXX" inputmode="numeric" autocomplete="tel" maxlength="14" data-required="true">
      </div>
    </div>

    <div class="ci-section" style="margin-top:18px;">Accounting Information</div>
    <div class="ci-sectionline"></div>

    <div class="ci-grid" style="margin-top:0;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Basis of Accounting</div>
        </div>
      </div>
    </div>

    <div class="ci-basis-row" role="group" aria-label="Basis of Accounting" style="margin-top:0;" data-required-radio="boa_basis">
      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_accrual" value="Accrual Basis">
        Accrual Basis
      </label>

      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_cash" value="Cash Basis">
        Cash Basis
      </label>

      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_mixed" value="Mixed Method">
        Mixed Method
      </label>

      <div class="ci-other-wrap">
        <label class="ci-radio">
          <input type="radio" name="boa_basis" id="boa_other" value="Other">
          Other
        </label>
        <input class="ci-other-input" id="boa_other_text" type="text" placeholder="Specify" autocomplete="off" disabled data-required-when="boa_other">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:16px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Do you have another accountant?</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Do you have another accountant?" style="margin-top:0;" data-required-radio="ai_other_accountant">
          <label class="ci-radio">
            <input type="radio" name="ai_other_accountant" id="ai_other_acct_yes" value="Yes">
            Yes
          </label>

          <label class="ci-radio">
            <input type="radio" name="ai_other_accountant" id="ai_other_acct_no" value="No">
            No
          </label>
        </div>
      </div>
    </div>

    <div class="ci-grid three" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Accountant Name</div>
        </div>
        <input class="ci-input" id="ai_accountant_name" type="text" placeholder="Accountant Name" autocomplete="name" disabled data-required-when="ai_other_acct_yes">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Phone Number</div>
        </div>
        <input class="ci-input" id="ai_accountant_phone" type="tel" placeholder="(XXX) XXX-XXXX" inputmode="numeric" autocomplete="tel" maxlength="14" disabled data-required-when="ai_other_acct_yes">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Email Address</div>
        </div>
        <input class="ci-input" id="ai_accountant_email" type="email" placeholder="Email Address" autocomplete="email" disabled data-required-when="ai_other_acct_yes">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:16px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Do you currently use an accounting software?</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Do you currently use an accounting software?" style="margin-top:0;" data-required-radio="ai_use_accounting_software">
          <label class="ci-radio">
            <input type="radio" name="ai_use_accounting_software" id="ai_sw_yes" value="Yes">
            Yes
          </label>

          <label class="ci-radio">
            <input type="radio" name="ai_use_accounting_software" id="ai_sw_no" value="No">
            No
          </label>

          <div class="ci-other-wrap" style="min-width:320px;">
            <div class="ci-label" style="font-size:13px;font-weight:950;opacity:.92;white-space:nowrap;">If yes, specify</div>
            <input class="ci-other-input" id="ai_sw_specify" type="text" placeholder="Accounting Software" autocomplete="off" disabled data-required-when="ai_sw_yes">
          </div>
        </div>
      </div>
    </div>

    <div class="ci-grid" style="margin-top:16px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Do you have accounting records for the full life of the business?</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Do you have accounting records for the full life of the business?" style="margin-top:0;" data-required-radio="ai_records_full_history">
          <label class="ci-radio">
            <input type="radio" name="ai_records_full_history" id="ai_records_yes" value="Yes">
            Yes
          </label>

          <label class="ci-radio">
            <input type="radio" name="ai_records_full_history" id="ai_records_no" value="No">
            No
          </label>
        </div>
      </div>
    </div>

    <div class="ci-section" style="margin-top:18px;">Payment Information</div>
    <div class="ci-sectionline"></div>

    <div class="ci-note" id="pay_notice">
      Payment not charged at this time. Payment information collected for payment-related onboarding agreements.
    </div>

    <div class="ci-grid" style="margin-top:12px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">We require all clients to keep a debit or credit card on file. Please fill out the following:</div>
        </div>
      </div>
    </div>

    <div class="ci-grid paymeta" style="margin-top:10px;">
      <div class="ci-field">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Card Ownership</div>
        </div>
        <div class="ci-basis-row tight" role="group" aria-label="Card Ownership" style="margin-top:0;" data-required-radio="pay_card_ownership">
          <label class="ci-radio">
            <input type="radio" name="pay_card_ownership" id="pay_own_personal" value="Personal">
            Personal Card
          </label>
          <label class="ci-radio">
            <input type="radio" name="pay_card_ownership" id="pay_own_business" value="Business">
            Business Card
          </label>
        </div>
      </div>

      <div class="ci-field">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Card Type</div>
        </div>
        <div class="ci-basis-row tight" role="group" aria-label="Card Type" style="margin-top:0;" data-required-radio="pay_card_type">
          <label class="ci-radio">
            <input type="radio" name="pay_card_type" id="pay_type_debit" value="Debit">
            Debit
          </label>
          <label class="ci-radio">
            <input type="radio" name="pay_card_type" id="pay_type_credit" value="Credit">
            Credit
          </label>
        </div>
      </div>
    </div>

    <div class="ci-grid" style="margin-top:12px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow" style="margin-bottom:8px;">
          <div class="ci-label">Card Issuer</div>
        </div>

        <div class="ci-basis-row" role="group" aria-label="Card Issuer" style="margin-top:0;" data-required-radio="pay_card_brand">
          <label class="ci-radio">
            <input type="radio" name="pay_card_brand" id="pay_card_mc" value="Mastercard">
            Mastercard
          </label>

          <label class="ci-radio">
            <input type="radio" name="pay_card_brand" id="pay_card_visa" value="Visa">
            Visa
          </label>

          <label class="ci-radio">
            <input type="radio" name="pay_card_brand" id="pay_card_amex" value="American Express">
            American Express
          </label>

          <label class="ci-radio">
            <input type="radio" name="pay_card_brand" id="pay_card_disc" value="Discover">
            Discover
          </label>
        </div>
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow">
          <div class="ci-label">Name on Card</div>
        </div>
        <input class="ci-input" id="pay_name_on_card" type="text" placeholder="Name on Card" autocomplete="cc-name" data-required="true">
      </div>
    </div>

    <div class="ci-grid paycard" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Card Number</div>
        </div>
        <input class="ci-input" id="pay_card_number" type="text" placeholder="XXXX XXXX XXXX XXXX" inputmode="numeric" autocomplete="cc-number" maxlength="19" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Expiration Date</div>
          <div class="ci-hint" id="pay_exp_hint"></div>
        </div>
        <input class="ci-input" id="pay_card_exp" type="text" placeholder="MM/YY" inputmode="numeric" autocomplete="cc-exp" maxlength="5" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">CVV</div>
        </div>
        <input class="ci-input" id="pay_card_cvv" type="text" placeholder="CVV" inputmode="numeric" autocomplete="cc-csc" maxlength="4" data-required="true">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Zip Code</div>
        </div>
        <input class="ci-input" id="pay_card_zip" type="text" placeholder="Zip Code" inputmode="numeric" autocomplete="postal-code" maxlength="10" data-required="true">
      </div>
    </div>

    <div class="ci-submitline"></div>

    <div class="ci-actions">
      <button class="ci-submit" id="ci_submit_intake" type="button">Submit Client Intake Form</button>
      <div class="ci-submit-msg" id="ci_submit_msg">Please complete all required fields.</div>
    </div>

  </div>
</template>

<script>
  (function(){
    const STORAGE_KEY_INTAKE = "carbyne_intake_business_info";
    const DOC_ID_INTAKE = "client_intake_form";

    function onlyDigits(s){ return (s || "").replace(/\D/g,""); }

    function formatPhone(raw){
      const d = onlyDigits(raw).slice(0,10);
      const a = d.slice(0,3);
      const b = d.slice(3,6);
      const c = d.slice(6,10);
      if (!d) return "";
      if (d.length <= 3) return "(" + a;
      if (d.length <= 6) return "(" + a + ") " + b;
      return "(" + a + ") " + b + "-" + c;
    }

    function formatFein(raw){
      const d = onlyDigits(raw).slice(0,9);
      if (!d) return "";
      if (d.length <= 2) return d;
      return d.slice(0,2) + "-" + d.slice(2);
    }

    function formatZip(raw){
      const d = onlyDigits(raw).slice(0,9);
      if (!d) return "";
      if (d.length <= 5) return d;
      return d.slice(0,5) + "-" + d.slice(5);
    }

    function getSelectedValue(root, name){
      const sel = root.querySelector('input[type="radio"][name="'+name+'"]:checked');
      return sel ? (sel.value || "") : "";
    }

    function formatCardNumber(raw, brand){
      const d = onlyDigits(raw);
      if (brand === "American Express"){
        const x = d.slice(0,15);
        const p1 = x.slice(0,4);
        const p2 = x.slice(4,10);
        const p3 = x.slice(10,15);
        if (!x) return "";
        if (x.length <= 4) return p1;
        if (x.length <= 10) return p1 + " " + p2;
        return p1 + " " + p2 + " " + p3;
      } else {
        const x = d.slice(0,16);
        const parts = [];
        for (let i=0;i<x.length;i+=4){
          parts.push(x.slice(i,i+4));
        }
        return parts.join(" ");
      }
    }

    function formatExp(raw){
      const d = onlyDigits(raw).slice(0,4);
      if (!d) return "";
      if (d.length <= 2) return d;
      return d.slice(0,2) + "/" + d.slice(2);
    }

    function parseExp(mmYY){
      const d = onlyDigits(mmYY);
      if (d.length !== 4) return null;
      const mm = parseInt(d.slice(0,2), 10);
      const yy = parseInt(d.slice(2,4), 10);
      if (!mm || mm < 1 || mm > 12) return null;
      const year = 2000 + yy;
      return { mm, year };
    }

    function isExpNotExpired(mmYY){
      const p = parseExp(mmYY);
      if (!p) return false;
      const now = new Date();
      const curYear = now.getFullYear();
      const curMonth = now.getMonth() + 1;
      if (p.year > curYear) return true;
      if (p.year < curYear) return false;
      return p.mm >= curMonth;
    }

    function maxCvvLen(brand){
      return (brand === "American Express") ? 4 : 3;
    }

    function normalize(v){ return (v ?? "").toString().trim(); }

    function injectAsterisks(root){
      const labels = Array.from(root.querySelectorAll(".ci-label"));
      labels.forEach(l=>{
        if (!l) return;
        if (l.querySelector(".ci-req")) return;
        const star = document.createElement("span");
        star.className = "ci-req";
        star.textContent = "*";
        l.appendChild(star);
      });
    }

    function loadSaved(root){
      try{
        const raw = localStorage.getItem(STORAGE_KEY_INTAKE);
        if (!raw) return;
        const data = JSON.parse(raw);

        const ids = [
          "bi_name","bi_fein","bi_formation_date","bi_fullname","bi_title",
          "bi_industry","bi_address","bi_suite",
          "bi_city","bi_state","bi_zip","bi_phone","bi_email","bi_poc",
          "poc_email","poc_phone",
          "boa_other_text",
          "ai_accountant_name","ai_accountant_phone","ai_accountant_email",
          "ai_sw_specify",
          "pay_name_on_card",
          "pay_card_number","pay_card_exp","pay_card_cvv","pay_card_zip"
        ];

        ids.forEach(id=>{
          const el = root.querySelector("#"+id);
          if (!el) return;
          el.value = (data[id] ?? "");
        });

        const cb = root.querySelector("#bi_no_fein");
        if (cb){
          cb.checked = !!data["bi_no_fein"];
        }

        const savedBasis = (data["boa_basis"] ?? "");
        if (savedBasis){
          const radios = Array.from(root.querySelectorAll('input[type="radio"][name="boa_basis"]'));
          radios.forEach(r=>{ r.checked = (r.value === savedBasis); });
        }

        const savedOtherAcct = (data["ai_other_accountant"] ?? "");
        if (savedOtherAcct){
          const radios2 = Array.from(root.querySelectorAll('input[type="radio"][name="ai_other_accountant"]'));
          radios2.forEach(r=>{ r.checked = (r.value === savedOtherAcct); });
        }

        const savedUseSw = (data["ai_use_accounting_software"] ?? "");
        if (savedUseSw){
          const radios3 = Array.from(root.querySelectorAll('input[type="radio"][name="ai_use_accounting_software"]'));
          radios3.forEach(r=>{ r.checked = (r.value === savedUseSw); });
        }

        const savedRecords = (data["ai_records_full_history"] ?? "");
        if (savedRecords){
          const radios4 = Array.from(root.querySelectorAll('input[type="radio"][name="ai_records_full_history"]'));
          radios4.forEach(r=>{ r.checked = (r.value === savedRecords); });
        }

        const savedBrand = (data["pay_card_brand"] ?? "");
        if (savedBrand){
          const radios5 = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_brand"]'));
          radios5.forEach(r=>{ r.checked = (r.value === savedBrand); });
        }

        const savedOwnership = (data["pay_card_ownership"] ?? "");
        if (savedOwnership){
          const radios6 = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_ownership"]'));
          radios6.forEach(r=>{ r.checked = (r.value === savedOwnership); });
        }

        const savedType = (data["pay_card_type"] ?? "");
        if (savedType){
          const radios7 = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_type"]'));
          radios7.forEach(r=>{ r.checked = (r.value === savedType); });
        }
      } catch {}
    }

    function save(root){
      const out = {};
      const ids = [
        "bi_name","bi_fein","bi_formation_date","bi_fullname","bi_title",
        "bi_industry","bi_address","bi_suite",
        "bi_city","bi_state","bi_zip","bi_phone","bi_email","bi_poc",
        "poc_email","poc_phone",
        "ai_accountant_name","ai_accountant_phone","ai_accountant_email",
        "ai_sw_specify",
        "pay_name_on_card",
        "pay_card_number","pay_card_exp","pay_card_cvv","pay_card_zip"
      ];
      ids.forEach(id=>{
        const el = root.querySelector("#"+id);
        if (!el) return;
        out[id] = el.value || "";
      });

      const cb = root.querySelector("#bi_no_fein");
      out["bi_no_fein"] = cb ? !!cb.checked : false;

      out["boa_basis"] = getSelectedValue(root, "boa_basis");
      const otherText = root.querySelector("#boa_other_text");
      out["boa_other_text"] = otherText ? (otherText.value || "") : "";

      out["ai_other_accountant"] = getSelectedValue(root, "ai_other_accountant");
      out["ai_use_accounting_software"] = getSelectedValue(root, "ai_use_accounting_software");
      out["ai_records_full_history"] = getSelectedValue(root, "ai_records_full_history");

      out["pay_card_brand"] = getSelectedValue(root, "pay_card_brand");
      out["pay_card_ownership"] = getSelectedValue(root, "pay_card_ownership");
      out["pay_card_type"] = getSelectedValue(root, "pay_card_type");

      try{ localStorage.setItem(STORAGE_KEY_INTAKE, JSON.stringify(out)); } catch {}
    }

    async function getPublicIP(){
      try{
        if (typeof window.carbyne_get_public_ip === "function"){
          const ip = await window.carbyne_get_public_ip();
          return normalize(ip) || "Unavailable";
        }
      } catch {}
      try{
        const res = await fetch("https://api.ipify.org?format=json", { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const j = await res.json();
        const ip = normalize(j && j.ip);
        return ip || "Unavailable";
      } catch {
        return "Unavailable";
      }
    }

    function stamp(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const yy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return mm + "/" + dd + "/" + yy + " " + hh + ":" + mi;
    }

    function validateRequired(root){
      let ok = true;

      const msg = root.querySelector("#ci_submit_msg");
      if (msg) msg.classList.remove("show");

      const requiredFields = Array.from(root.querySelectorAll("[data-required='true']"));
      requiredFields.forEach(el=>{
        if (!el) return;

        if (el.disabled) { el.classList.remove("ci-error"); return; }

        const v = normalize(el.value);
        if (!v || (el.tagName.toLowerCase()==="select" && !v)){
          el.classList.add("ci-error");
          ok = false;
        } else {
          el.classList.remove("ci-error");
        }
      });

      const fein = root.querySelector("#bi_fein");
      const noFein = root.querySelector("#bi_no_fein");
      if (fein){
        const needFein = !(noFein && noFein.checked);
        if (needFein){
          const fv = normalize(fein.value);
          if (!fv || fv.toLowerCase()==="unavailable"){
            fein.classList.add("ci-error");
            ok = false;
          } else {
            fein.classList.remove("ci-error");
          }
        } else {
          fein.classList.remove("ci-error");
        }
      }

      const radioGroups = Array.from(root.querySelectorAll("[data-required-radio]"))
        .map(el => el.getAttribute("data-required-radio"))
        .filter(Boolean);

      radioGroups.forEach(name=>{
        const checked = root.querySelector('input[type="radio"][name="'+name+'"]:checked');
        if (!checked) ok = false;
      });

      const conditional = Array.from(root.querySelectorAll("[data-required-when]"));
      conditional.forEach(el=>{
        const condId = el.getAttribute("data-required-when");
        const condEl = condId ? root.querySelector("#"+condId) : null;
        const active = !!(condEl && condEl.checked);

        if (!active){
          el.classList.remove("ci-error");
          return;
        }

        if (el.disabled) return;

        const v = normalize(el.value);
        if (!v){
          el.classList.add("ci-error");
          ok = false;
        } else {
          el.classList.remove("ci-error");
        }
      });

      const payExp = root.querySelector("#pay_card_exp");
      if (payExp){
        const v = normalize(payExp.value);
        if (v && !isExpNotExpired(v)){
          payExp.classList.add("ci-error");
          ok = false;
        }
      }

      if (!ok && msg) msg.classList.add("show");
      return ok;
    }

    function bytesToB64(bytes){
      let s = "";
      const chunk = 0x8000;
      for (let i=0;i<bytes.length;i+=chunk){
        s += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
      }
      return btoa(s);
    }

    async function buildIntakePdfB64(referenceNumber, formData, audit){
      const lib = window.PDFLib;
      if (!lib || !lib.PDFDocument) throw new Error("PDFLib unavailable");

      const { PDFDocument, StandardFonts } = lib;

      const pdfDoc = await PDFDocument.create();
      const page = pdfDoc.addPage([612, 792]);
      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
      const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

      const marginX = 54;
      const topY = 742;
      let y = topY;

      function drawLine(text, isBold){
        const f = isBold ? fontBold : font;
        const size = 10;
        page.drawText(text, { x: marginX, y: y, size, font: f });
        y -= 14;
      }

      function drawKV(k, v){
        drawLine((k || "") + ": " + (v || ""), false);
      }

      drawLine("Client Intake Form", true);
      drawLine("Reference Number: " + (referenceNumber || ""), false);
      drawLine(" ", false);

      drawLine("Business Information", true);
      drawKV("Name of Business", formData.bi_name);
      drawKV("Employer Identification Number (EIN)", formData.bi_fein);
      drawKV("Business Formation Date", formData.bi_formation_date);
      drawKV("Full Name of Person Completing this Agreement", formData.bi_fullname);
      drawKV("Title", formData.bi_title);
      drawKV("Business Industry", formData.bi_industry);
      drawKV("Business Address", formData.bi_address);
      drawKV("Suite / Unit Number", formData.bi_suite);
      drawKV("City", formData.bi_city);
      drawKV("State", formData.bi_state);
      drawKV("Zip Code", formData.bi_zip);
      drawKV("Business Phone Number", formData.bi_phone);
      drawKV("Business Email Address", formData.bi_email);
      drawKV("Point of Contact (POC)", formData.bi_poc);
      drawKV("POC Email", formData.poc_email);
      drawKV("POC Phone Number", formData.poc_phone);

      drawLine(" ", false);
      drawLine("Accounting Information", true);
      drawKV("Basis of Accounting", formData.boa_basis === "Other" ? ("Other: " + (formData.boa_other_text || "")) : (formData.boa_basis || ""));
      drawKV("Do you have another accountant?", formData.ai_other_accountant);
      if ((formData.ai_other_accountant || "") === "Yes"){
        drawKV("Accountant Name", formData.ai_accountant_name);
        drawKV("Accountant Phone Number", formData.ai_accountant_phone);
        drawKV("Accountant Email Address", formData.ai_accountant_email);
      }
      drawKV("Do you currently use an accounting software?", formData.ai_use_accounting_software);
      if ((formData.ai_use_accounting_software || "") === "Yes"){
        drawKV("Accounting Software", formData.ai_sw_specify);
      }
      drawKV("Do you have accounting records for the full life of the business?", formData.ai_records_full_history);

      drawLine(" ", false);
      drawLine("Payment Information", true);
      drawKV("Card Ownership", formData.pay_card_ownership);
      drawKV("Card Type", formData.pay_card_type);
      drawKV("Card Issuer", formData.pay_card_brand);
      drawKV("Name on Card", formData.pay_name_on_card);
      drawKV("Card Number", formData.pay_card_number);
      drawKV("Expiration Date", formData.pay_card_exp);
      drawKV("CVV", formData.pay_card_cvv);
      drawKV("Zip Code", formData.pay_card_zip);

      drawLine(" ", false);
      drawLine("Audit Log", true);

      const ua = (audit.userAgent || "").toString();
      const maxWidth = 504;
      const size = 10;

      function wrapText(text, f){
        const words = (text || "").split(/\s+/).filter(Boolean);
        const lines = [];
        let line = "";
        for (const w of words){
          const test = line ? (line + " " + w) : w;
          const width = f.widthOfTextAtSize(test, size);
          if (width <= maxWidth){
            line = test;
          } else {
            if (line) lines.push(line);
            line = w;
          }
        }
        if (line) lines.push(line);
        return lines;
      }

      drawKV("Timestamp", audit.timestamp);
      drawKV("Public IP", audit.publicIP);
      drawKV("Time Zone", audit.timezone);
      drawKV("Platform", audit.platform);
      drawLine("User Agent:", false);

      const uaLines = wrapText(ua, font);
      uaLines.forEach(l=>{
        page.drawText(l, { x: marginX, y: y, size, font });
        y -= 14;
      });

      const bytes = await pdfDoc.save();
      return bytesToB64(bytes);
    }

    window.carbyne_client_intake_mount = function(args){
      const root = args && args.root ? args.root : document;
      const referenceNumber = args && args.referenceNumber ? args.referenceNumber : "";

      injectAsterisks(root);

      const fein = root.querySelector("#bi_fein");
      const noFein = root.querySelector("#bi_no_fein");
      const phone = root.querySelector("#bi_phone");
      const zip = root.querySelector("#bi_zip");

      const pocPhone = root.querySelector("#poc_phone");
      const acctPhone = root.querySelector("#ai_accountant_phone");

      const boaOtherRadio = root.querySelector("#boa_other");
      const boaOtherText = root.querySelector("#boa_other_text");
      const boaRadios = Array.from(root.querySelectorAll('input[type="radio"][name="boa_basis"]'));

      const otherAcctRadios = Array.from(root.querySelectorAll('input[type="radio"][name="ai_other_accountant"]'));
      const otherAcctYes = root.querySelector("#ai_other_acct_yes");

      const acctName = root.querySelector("#ai_accountant_name");
      const acctEmail = root.querySelector("#ai_accountant_email");

      const useSwRadios = Array.from(root.querySelectorAll('input[type="radio"][name="ai_use_accounting_software"]'));
      const useSwYes = root.querySelector("#ai_sw_yes");
      const swSpecify = root.querySelector("#ai_sw_specify");

      const payBrandRadios = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_brand"]'));
      const payOwnerRadios = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_ownership"]'));
      const payTypeRadios = Array.from(root.querySelectorAll('input[type="radio"][name="pay_card_type"]'));

      const payCardNumber = root.querySelector("#pay_card_number");
      const payCardExp = root.querySelector("#pay_card_exp");
      const payCardCvv = root.querySelector("#pay_card_cvv");
      const payCardZip = root.querySelector("#pay_card_zip");
      const payExpHint = root.querySelector("#pay_exp_hint");

      const submitBtn = root.querySelector("#ci_submit_intake");
      const submitMsg = root.querySelector("#ci_submit_msg");

      loadSaved(root);

      const onFeinInput = () => {
        if (!fein) return;
        if (noFein && noFein.checked) return;
        fein.value = formatFein(fein.value);
        save(root);
      };

      const onNoFeinToggle = () => {
        if (!fein || !noFein) return;

        if (noFein.checked){
          fein.value = "Unavailable";
          fein.setAttribute("readonly","readonly");
        } else {
          fein.removeAttribute("readonly");
          if (normalize(fein.value).toLowerCase() === "unavailable"){
            fein.value = "";
          }
        }
        save(root);
      };

      const onPhoneInput = () => {
        if (!phone) return;
        phone.value = formatPhone(phone.value);
        save(root);
      };

      const onPocPhoneInput = () => {
        if (!pocPhone) return;
        pocPhone.value = formatPhone(pocPhone.value);
        save(root);
      };

      const onAcctPhoneInput = () => {
        if (!acctPhone) return;
        acctPhone.value = formatPhone(acctPhone.value);
        save(root);
      };

      const onZipInput = () => {
        if (!zip) return;
        zip.value = formatZip(zip.value);
        save(root);
      };

      const onPayZipInput = () => {
        if (!payCardZip) return;
        payCardZip.value = formatZip(payCardZip.value);
        save(root);
      };

      function syncOtherState(){
        if (!boaOtherText) return;
        const active = !!(boaOtherRadio && boaOtherRadio.checked);
        if (active){
          boaOtherText.disabled = false;
        } else {
          boaOtherText.disabled = true;
          boaOtherText.value = "";
        }
        save(root);
      }

      function syncOtherAccountantState(){
        const yes = !!(otherAcctYes && otherAcctYes.checked);

        if (acctName) acctName.disabled = !yes;
        if (acctPhone) acctPhone.disabled = !yes;
        if (acctEmail) acctEmail.disabled = !yes;

        if (!yes){
          if (acctName) acctName.value = "";
          if (acctPhone) acctPhone.value = "";
          if (acctEmail) acctEmail.value = "";
        }
        save(root);
      }

      function syncAccountingSoftwareState(){
        if (!swSpecify) return;
        const yes = !!(useSwYes && useSwYes.checked);
        if (yes){
          swSpecify.disabled = false;
        } else {
          swSpecify.disabled = true;
          swSpecify.value = "";
        }
        save(root);
      }

      function validateExp(){
        if (!payCardExp) return;
        const v = payCardExp.value || "";
        if (!v){
          payCardExp.classList.remove("ci-invalid");
          payCardExp.removeAttribute("aria-invalid");
          if (payExpHint){
            payExpHint.textContent = "";
            payExpHint.classList.remove("bad");
          }
          return;
        }

        const okFormat = !!parseExp(v);
        const okNotExpired = okFormat && isExpNotExpired(v);

        if (!okFormat){
          payCardExp.classList.add("ci-invalid");
          payCardExp.setAttribute("aria-invalid","true");
          if (payExpHint){
            payExpHint.textContent = "Use MM/YY";
            payExpHint.classList.add("bad");
          }
          return;
        }

        if (!okNotExpired){
          payCardExp.classList.add("ci-invalid");
          payCardExp.setAttribute("aria-invalid","true");
          if (payExpHint){
            payExpHint.textContent = "Card expired";
            payExpHint.classList.add("bad");
          }
          return;
        }

        payCardExp.classList.remove("ci-invalid");
        payCardExp.removeAttribute("aria-invalid");
        if (payExpHint){
          payExpHint.textContent = "";
          payExpHint.classList.remove("bad");
        }
      }

      function syncCardFormat(){
        const brand = getSelectedValue(root, "pay_card_brand");

        if (payCardNumber){
          if (brand === "American Express"){
            payCardNumber.setAttribute("maxlength","17");
            payCardNumber.placeholder = "XXXX XXXXXX XXXXX";
          } else {
            payCardNumber.setAttribute("maxlength","19");
            payCardNumber.placeholder = "XXXX XXXX XXXX XXXX";
          }
          payCardNumber.value = formatCardNumber(payCardNumber.value, brand);
        }

        if (payCardCvv){
          const maxLen = maxCvvLen(brand);
          payCardCvv.setAttribute("maxlength", String(maxLen));
          payCardCvv.placeholder = (maxLen === 4) ? "4-digit CVV" : "3-digit CVV";
          payCardCvv.value = onlyDigits(payCardCvv.value).slice(0, maxLen);
        }

        validateExp();
        save(root);
      }

      const onPayCardNumberInput = () => {
        if (!payCardNumber) return;
        const brand = getSelectedValue(root, "pay_card_brand");
        payCardNumber.value = formatCardNumber(payCardNumber.value, brand);
        save(root);
      };

      const onPayExpInput = () => {
        if (!payCardExp) return;
        payCardExp.value = formatExp(payCardExp.value);
        validateExp();
        save(root);
      };

      const onPayExpBlur = () => {
        validateExp();
        save(root);
      };

      const onPayCvvInput = () => {
        if (!payCardCvv) return;
        const brand = getSelectedValue(root, "pay_card_brand");
        const maxLen = maxCvvLen(brand);
        payCardCvv.value = onlyDigits(payCardCvv.value).slice(0, maxLen);
        save(root);
      };

      const onAnyChange = () => {
        if (submitMsg) submitMsg.classList.remove("show");
        const errs = Array.from(root.querySelectorAll(".ci-error"));
        errs.forEach(el=>el.classList.remove("ci-error"));
        save(root);
      };

      const onBasisChange = () => syncOtherState();
      const onOtherAcctChange = () => syncOtherAccountantState();
      const onUseSwChange = () => syncAccountingSoftwareState();
      const onBrandChange = () => syncCardFormat();
      const onOtherTextInput = () => { if (!boaOtherText) return; save(root); };

      async function onSubmit(){
        if (submitMsg) submitMsg.classList.remove("show");

        const ok = validateRequired(root);
        if (!ok) return;

        if (submitBtn) submitBtn.disabled = true;

        try{
          save(root);

          const data = {};
          const ids = [
            "bi_name","bi_fein","bi_formation_date","bi_fullname","bi_title",
            "bi_industry","bi_address","bi_suite",
            "bi_city","bi_state","bi_zip","bi_phone","bi_email","bi_poc",
            "poc_email","poc_phone",
            "ai_accountant_name","ai_accountant_phone","ai_accountant_email",
            "ai_sw_specify",
            "pay_name_on_card",
            "pay_card_number","pay_card_exp","pay_card_cvv","pay_card_zip"
          ];
          ids.forEach(id=>{
            const el = root.querySelector("#"+id);
            data[id] = el ? (el.value || "") : "";
          });

          data["boa_basis"] = getSelectedValue(root, "boa_basis");
          const otherText = root.querySelector("#boa_other_text");
          data["boa_other_text"] = otherText ? (otherText.value || "") : "";

          data["ai_other_accountant"] = getSelectedValue(root, "ai_other_accountant");
          data["ai_use_accounting_software"] = getSelectedValue(root, "ai_use_accounting_software");
          data["ai_records_full_history"] = getSelectedValue(root, "ai_records_full_history");

          data["pay_card_brand"] = getSelectedValue(root, "pay_card_brand");
          data["pay_card_ownership"] = getSelectedValue(root, "pay_card_ownership");
          data["pay_card_type"] = getSelectedValue(root, "pay_card_type");

          const ip = await getPublicIP();

          const audit = {
            timestamp: stamp(),
            publicIP: ip,
            timezone: (Intl && Intl.DateTimeFormat) ? (Intl.DateTimeFormat().resolvedOptions().timeZone || "") : "",
            platform: (navigator && navigator.platform) ? navigator.platform : "",
            userAgent: (navigator && navigator.userAgent) ? navigator.userAgent : ""
          };

          const b64 = await buildIntakePdfB64(referenceNumber, data, audit);

          window.dispatchEvent(new CustomEvent("carbyne:pdfdoc:upsert", {
            detail: {
              id: DOC_ID_INTAKE,
              title: "Client Intake Form",
              b64: b64,
              meta: {
                referenceNumber: referenceNumber || "",
                createdAt: audit.timestamp,
                publicIP: audit.publicIP
              }
            }
          }));
        } catch {
          if (submitMsg){
            submitMsg.textContent = "Unable to generate document.";
            submitMsg.classList.add("show");
          }
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }
      }

      if (fein){
        fein.addEventListener("input", onFeinInput);
        fein.addEventListener("blur", onFeinInput);
      }
      if (noFein){
        noFein.addEventListener("change", onNoFeinToggle);
        onNoFeinToggle();
      }
      if (phone){
        phone.addEventListener("input", onPhoneInput);
        phone.addEventListener("blur", onPhoneInput);
      }
      if (pocPhone){
        pocPhone.addEventListener("input", onPocPhoneInput);
        pocPhone.addEventListener("blur", onPocPhoneInput);
      }
      if (acctPhone){
        acctPhone.addEventListener("input", onAcctPhoneInput);
        acctPhone.addEventListener("blur", onAcctPhoneInput);
      }
      if (zip){
        zip.addEventListener("input", onZipInput);
        zip.addEventListener("blur", onZipInput);
      }

      boaRadios.forEach(r=>{ r.addEventListener("change", onBasisChange); });

      if (boaOtherText){
        boaOtherText.addEventListener("input", onOtherTextInput);
        boaOtherText.addEventListener("change", onOtherTextInput);
        boaOtherText.addEventListener("blur", onOtherTextInput);
      }

      otherAcctRadios.forEach(r=>{ r.addEventListener("change", onOtherAcctChange); });
      useSwRadios.forEach(r=>{ r.addEventListener("change", onUseSwChange); });

      if (swSpecify){
        swSpecify.addEventListener("input", onAnyChange);
        swSpecify.addEventListener("change", onAnyChange);
        swSpecify.addEventListener("blur", onAnyChange);
      }

      payBrandRadios.forEach(r=>{ r.addEventListener("change", onBrandChange); });
      payOwnerRadios.forEach(r=>{ r.addEventListener("change", onAnyChange); });
      payTypeRadios.forEach(r=>{ r.addEventListener("change", onAnyChange); });

      if (payCardNumber){
        payCardNumber.addEventListener("input", onPayCardNumberInput);
        payCardNumber.addEventListener("blur", onPayCardNumberInput);
      }
      if (payCardExp){
        payCardExp.addEventListener("input", onPayExpInput);
        payCardExp.addEventListener("blur", onPayExpBlur);
        payCardExp.addEventListener("change", onPayExpBlur);
      }
      if (payCardCvv){
        payCardCvv.addEventListener("input", onPayCvvInput);
        payCardCvv.addEventListener("blur", onPayCvvInput);
      }
      if (payCardZip){
        payCardZip.addEventListener("input", onPayZipInput);
        payCardZip.addEventListener("blur", onPayZipInput);
      }

      syncOtherState();
      syncOtherAccountantState();
      syncAccountingSoftwareState();
      syncCardFormat();
      validateExp();

      const allInputs = Array.from(root.querySelectorAll("input,select"));
      allInputs.forEach(el=>{
        el.addEventListener("input", onAnyChange);
        el.addEventListener("change", onAnyChange);
        el.addEventListener("blur", onAnyChange);
      });

      if (submitBtn){
        submitBtn.addEventListener("click", onSubmit);
      }

      return function unmount(){
        if (fein){
          fein.removeEventListener("input", onFeinInput);
          fein.removeEventListener("blur", onFeinInput);
        }
        if (noFein){
          noFein.removeEventListener("change", onNoFeinToggle);
        }
        if (phone){
          phone.removeEventListener("input", onPhoneInput);
          phone.removeEventListener("blur", onPhoneInput);
        }
        if (pocPhone){
          pocPhone.removeEventListener("input", onPocPhoneInput);
          pocPhone.removeEventListener("blur", onPocPhoneInput);
        }
        if (acctPhone){
          acctPhone.removeEventListener("input", onAcctPhoneInput);
          acctPhone.removeEventListener("blur", onAcctPhoneInput);
        }
        if (zip){
          zip.removeEventListener("input", onZipInput);
          zip.removeEventListener("blur", onZipInput);
        }

        boaRadios.forEach(r=>{ r.removeEventListener("change", onBasisChange); });

        if (boaOtherText){
          boaOtherText.removeEventListener("input", onOtherTextInput);
          boaOtherText.removeEventListener("change", onOtherTextInput);
          boaOtherText.removeEventListener("blur", onOtherTextInput);
        }

        otherAcctRadios.forEach(r=>{ r.removeEventListener("change", onOtherAcctChange); });
        useSwRadios.forEach(r=>{ r.removeEventListener("change", onUseSwChange); });

        if (swSpecify){
          swSpecify.removeEventListener("input", onAnyChange);
          swSpecify.removeEventListener("change", onAnyChange);
          swSpecify.removeEventListener("blur", onAnyChange);
        }

        payBrandRadios.forEach(r=>{ r.removeEventListener("change", onBrandChange); });
        payOwnerRadios.forEach(r=>{ r.removeEventListener("change", onAnyChange); });
        payTypeRadios.forEach(r=>{ r.removeEventListener("change", onAnyChange); });

        if (payCardNumber){
          payCardNumber.removeEventListener("input", onPayCardNumberInput);
          payCardNumber.removeEventListener("blur", onPayCardNumberInput);
        }
        if (payCardExp){
          payCardExp.removeEventListener("input", onPayExpInput);
          payCardExp.removeEventListener("blur", onPayExpBlur);
          payCardExp.removeEventListener("change", onPayExpBlur);
        }
        if (payCardCvv){
          payCardCvv.removeEventListener("input", onPayCvvInput);
          payCardCvv.removeEventListener("blur", onPayCvvInput);
        }
        if (payCardZip){
          payCardZip.removeEventListener("input", onPayZipInput);
          payCardZip.removeEventListener("blur", onPayZipInput);
        }

        allInputs.forEach(el=>{
          el.removeEventListener("input", onAnyChange);
          el.removeEventListener("change", onAnyChange);
          el.removeEventListener("blur", onAnyChange);
        });

        if (submitBtn){
          submitBtn.removeEventListener("click", onSubmit);
        }
      };
    };
  })();
</script>

</body>
</html>
