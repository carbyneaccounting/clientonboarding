<!-- clientintakeform.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Client Intake Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<template id="carbyne_client_intake">
  <style>
    .ci-wrap{
      width:100%;
      max-width:980px;
    }

    .ci-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding:4px 2px 0;
    }

    .ci-h2{
      margin:0;
      font-size:28px;
      font-weight:950;
      color:#0b2f4e;
      letter-spacing:.2px;
    }

    .ci-section{
      margin-top:12px;
      font-size:14px;
      font-weight:950;
      color:#0f172a;
      letter-spacing:.2px;
    }

    .ci-spacer{height:10px}

    .ci-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:14px;
      margin-top:10px;
    }

    .ci-grid.three{
      grid-template-columns:repeat(3, minmax(0,1fr));
    }

    .ci-field{width:100%}

    .ci-labelrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 8px;
    }

    .ci-label{
      font-size:13px;
      font-weight:950;
      color:#0f172a;
      opacity:.92;
    }

    .ci-inline{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      font-weight:950;
      color:#0f172a;
      opacity:.85;
      white-space:nowrap;
    }

    .ci-check{
      width:16px;height:16px;
      accent-color:#00305B;
      cursor:pointer;
    }

    .ci-input, .ci-select{
      width:100%;
      border:1px solid rgba(0,0,0,.14);
      border-radius:14px;
      padding:14px 16px;
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
      transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease, opacity .18s ease;
      color:#0f172a;
    }

    .ci-input::placeholder{color:#64748b;font-weight:900;opacity:.75}

    .ci-input:focus, .ci-select:focus{
      border-color:rgba(0,48,91,.70);
      box-shadow:0 0 0 3px rgba(0,48,91,.16), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.6;
    }
    .ci-input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    .ci-input:disabled{
      background:#f1f5f9;
      color:#64748b;
      box-shadow:none;
      opacity:.95;
      cursor:not-allowed;
    }

    .ci-wide{grid-column:1 / -1}

    /* Basis of Accounting */
    .ci-basis-row{
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:nowrap; /* keep one line */
      margin-top:10px;
      padding:2px 2px 0;
      width:100%;
    }

    .ci-radio{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      font-weight:950;
      color:#0f172a;
      opacity:.92;
      white-space:nowrap;
      user-select:none;
      flex:0 0 auto;
    }

    .ci-radio input[type="radio"]{
      width:16px;height:16px;
      accent-color:#00305B;
      cursor:pointer;
      flex:0 0 auto;
    }

    .ci-other-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1 1 auto;      /* take remaining space */
      min-width:220px;    /* prevents collapsing too hard */
    }

    .ci-other-input{
      flex:1 1 auto;      /* fill remaining width */
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.14);
      font-size:14px;
      font-weight:900;
      outline:none;
      background:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
      transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease, opacity .18s ease;
      color:#0f172a;
      min-width:0;        /* allow flexbox to shrink properly */
    }

    .ci-other-input::placeholder{color:#64748b;font-weight:900;opacity:.75}

    .ci-other-input:focus{
      border-color:rgba(0,48,91,.70);
      box-shadow:0 0 0 3px rgba(0,48,91,.16), 0 12px 24px rgba(2,6,23,.10);
    }

    .ci-other-input:disabled{
      background:#f1f5f9;
      color:#64748b;
      box-shadow:none;
      opacity:.95;
      cursor:not-allowed;
    }

    @media (max-width:820px){
      .ci-grid, .ci-grid.three{grid-template-columns:1fr}
      .ci-basis-row{flex-wrap:wrap} /* allow wrap on small screens */
      .ci-other-wrap{flex:1 1 100%}
    }
  </style>

  <div class="ci-wrap" id="ciRoot">
    <div class="ci-top">
      <h2 class="ci-h2">Client Intake Form</h2>
      <div></div>
    </div>

    <div class="ci-spacer"></div>

    <div class="ci-section">Business Information</div>

    <div class="ci-grid">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Name of Business</div>
        </div>
        <input class="ci-input" id="bi_name" type="text" placeholder="Name of Business" autocomplete="organization">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Federal Employer Identification Number (FEIN)</div>
          <label class="ci-inline">
            <input class="ci-check" id="bi_no_fein" type="checkbox">
            No FEIN
          </label>
        </div>
        <input class="ci-input" id="bi_fein" type="text" placeholder="XX-XXXXXXX" inputmode="numeric" autocomplete="off" maxlength="10">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Formation Date</div>
        </div>
        <input class="ci-input" id="bi_formation_date" type="date" autocomplete="off">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Full Name of Person Completing this Agreement</div>
        </div>
        <input class="ci-input" id="bi_fullname" type="text" placeholder="Full Name" autocomplete="name">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Title</div>
        </div>
        <input class="ci-input" id="bi_title" type="text" placeholder="Title" autocomplete="organization-title">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Address</div>
        </div>
        <input class="ci-input" id="bi_address" type="text" placeholder="Business Address" autocomplete="street-address">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Suite / Unit Number</div>
        </div>
        <input class="ci-input" id="bi_suite" type="text" placeholder="Suite / Unit Number" autocomplete="address-line2">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">City</div>
        </div>
        <input class="ci-input" id="bi_city" type="text" placeholder="City" autocomplete="address-level2">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">State</div>
        </div>
        <select class="ci-select" id="bi_state" autocomplete="address-level1">
          <option value="" selected>Select</option>
          <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
          <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
          <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
          <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
          <option value="KY">KY</option>
          <option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
          <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
          <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
          <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
          <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
          <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
          <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
          <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
          <option value="WI">WI</option><option value="WY">WY</option>
        </select>
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Zip Code</div>
        </div>
        <input class="ci-input" id="bi_zip" type="text" placeholder="Zip Code" inputmode="numeric" autocomplete="postal-code" maxlength="10">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Phone Number</div>
        </div>
        <input class="ci-input" id="bi_phone" type="tel" placeholder="(XXX) XXX-XXXX" inputmode="numeric" autocomplete="tel" maxlength="14">
      </div>

      <div class="ci-field">
        <div class="ci-labelrow">
          <div class="ci-label">Business Email Address</div>
        </div>
        <input class="ci-input" id="bi_email" type="email" placeholder="Business Email Address" autocomplete="email">
      </div>
    </div>

    <div class="ci-grid" style="margin-top:14px;">
      <div class="ci-field ci-wide">
        <div class="ci-labelrow">
          <div class="ci-label">Business Point of Contact</div>
        </div>
        <input class="ci-input" id="bi_poc" type="text" placeholder="Business Point of Contact" autocomplete="name">
      </div>
    </div>

    <div class="ci-section" style="margin-top:18px;">Basis of Accounting</div>

    <div class="ci-basis-row" role="group" aria-label="Basis of Accounting">
      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_accrual" value="Accrual Basis">
        Accrual Basis
      </label>

      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_cash" value="Cash Basis">
        Cash Basis
      </label>

      <label class="ci-radio">
        <input type="radio" name="boa_basis" id="boa_mixed" value="Mixed Method">
        Mixed Method
      </label>

      <div class="ci-other-wrap">
        <label class="ci-radio">
          <input type="radio" name="boa_basis" id="boa_other" value="Other">
          Other
        </label>
        <input class="ci-other-input" id="boa_other_text" type="text" placeholder="Specify" autocomplete="off" disabled>
      </div>
    </div>
  </div>
</template>

<script>
  (function(){
    const STORAGE_KEY_INTAKE = "carbyne_intake_business_info";

    function onlyDigits(s){ return (s || "").replace(/\D/g,""); }

    function formatPhone(raw){
      const d = onlyDigits(raw).slice(0,10);
      const a = d.slice(0,3);
      const b = d.slice(3,6);
      const c = d.slice(6,10);
      if (!d) return "";
      if (d.length <= 3) return "(" + a;
      if (d.length <= 6) return "(" + a + ") " + b;
      return "(" + a + ") " + b + "-" + c;
    }

    function formatFein(raw){
      const d = onlyDigits(raw).slice(0,9);
      if (!d) return "";
      if (d.length <= 2) return d;
      return d.slice(0,2) + "-" + d.slice(2);
    }

    function formatZip(raw){
      const d = onlyDigits(raw).slice(0,9);
      if (!d) return "";
      if (d.length <= 5) return d;
      return d.slice(0,5) + "-" + d.slice(5);
    }

    function loadSaved(root){
      try{
        const raw = localStorage.getItem(STORAGE_KEY_INTAKE);
        if (!raw) return;
        const data = JSON.parse(raw);

        const ids = [
          "bi_name","bi_fein","bi_formation_date","bi_fullname","bi_title","bi_address","bi_suite",
          "bi_city","bi_state","bi_zip","bi_phone","bi_email","bi_poc",
          "boa_other_text"
        ];

        ids.forEach(id=>{
          const el = root.querySelector("#"+id);
          if (!el) return;
          el.value = (data[id] ?? "");
        });

        const cb = root.querySelector("#bi_no_fein");
        if (cb){
          cb.checked = !!data["bi_no_fein"];
        }

        const savedBasis = (data["boa_basis"] ?? "");
        if (savedBasis){
          const radios = Array.from(root.querySelectorAll('input[type="radio"][name="boa_basis"]'));
          radios.forEach(r=>{
            r.checked = (r.value === savedBasis);
          });
        }
      } catch {}
    }

    function save(root){
      const out = {};
      const ids = [
        "bi_name","bi_fein","bi_formation_date","bi_fullname","bi_title","bi_address","bi_suite",
        "bi_city","bi_state","bi_zip","bi_phone","bi_email","bi_poc"
      ];
      ids.forEach(id=>{
        const el = root.querySelector("#"+id);
        if (!el) return;
        out[id] = el.value || "";
      });

      const cb = root.querySelector("#bi_no_fein");
      out["bi_no_fein"] = cb ? !!cb.checked : false;

      const selected = root.querySelector('input[type="radio"][name="boa_basis"]:checked');
      out["boa_basis"] = selected ? (selected.value || "") : "";

      const otherText = root.querySelector("#boa_other_text");
      out["boa_other_text"] = otherText ? (otherText.value || "") : "";

      try{ localStorage.setItem(STORAGE_KEY_INTAKE, JSON.stringify(out)); } catch {}
    }

    window.carbyne_client_intake_mount = function(args){
      const root = args && args.root ? args.root : document;
      const fein = root.querySelector("#bi_fein");
      const noFein = root.querySelector("#bi_no_fein");
      const phone = root.querySelector("#bi_phone");
      const zip = root.querySelector("#bi_zip");

      const boaOtherRadio = root.querySelector("#boa_other");
      const boaOtherText = root.querySelector("#boa_other_text");
      const boaRadios = Array.from(root.querySelectorAll('input[type="radio"][name="boa_basis"]'));

      function syncOtherState(){
        if (!boaOtherText) return;
        const active = !!(boaOtherRadio && boaOtherRadio.checked);
        if (active){
          boaOtherText.disabled = false;
        } else {
          boaOtherText.disabled = true;
          boaOtherText.value = "";
        }
        save(root);
      }

      loadSaved(root);

      const onFeinInput = () => {
        if (!fein) return;
        if (noFein && noFein.checked) return;
        const formatted = formatFein(fein.value);
        fein.value = formatted;
        save(root);
      };

      const onNoFeinToggle = () => {
        if (!fein || !noFein) return;
        if (noFein.checked){
          fein.value = "Unavailable";
          fein.setAttribute("readonly","readonly");
        } else {
          fein.removeAttribute("readonly");
          fein.value = "";
        }
        save(root);
      };

      const onPhoneInput = () => {
        if (!phone) return;
        phone.value = formatPhone(phone.value);
        save(root);
      };

      const onZipInput = () => {
        if (!zip) return;
        zip.value = formatZip(zip.value);
        save(root);
      };

      const onAnyChange = () => save(root);

      const onBasisChange = () => {
        syncOtherState();
      };

      const onOtherTextInput = () => {
        if (!boaOtherText) return;
        save(root);
      };

      if (fein){
        fein.addEventListener("input", onFeinInput);
        fein.addEventListener("blur", onFeinInput);
      }
      if (noFein){
        noFein.addEventListener("change", onNoFeinToggle);
        onNoFeinToggle();
      }
      if (phone){
        phone.addEventListener("input", onPhoneInput);
        phone.addEventListener("blur", onPhoneInput);
      }
      if (zip){
        zip.addEventListener("input", onZipInput);
        zip.addEventListener("blur", onZipInput);
      }

      boaRadios.forEach(r=>{
        r.addEventListener("change", onBasisChange);
      });

      if (boaOtherText){
        boaOtherText.addEventListener("input", onOtherTextInput);
        boaOtherText.addEventListener("change", onOtherTextInput);
        boaOtherText.addEventListener("blur", onOtherTextInput);
      }

      syncOtherState();

      const allInputs = Array.from(root.querySelectorAll("input,select"));
      allInputs.forEach(el=>{
        if (
          el.id === "bi_fein" ||
          el.id === "bi_phone" ||
          el.id === "bi_zip" ||
          el.id === "bi_no_fein" ||
          el.name === "boa_basis" ||
          el.id === "boa_other_text"
        ) return;
        el.addEventListener("input", onAnyChange);
        el.addEventListener("change", onAnyChange);
        el.addEventListener("blur", onAnyChange);
      });

      return function unmount(){
        if (fein){
          fein.removeEventListener("input", onFeinInput);
          fein.removeEventListener("blur", onFeinInput);
        }
        if (noFein){
          noFein.removeEventListener("change", onNoFeinToggle);
        }
        if (phone){
          phone.removeEventListener("input", onPhoneInput);
          phone.removeEventListener("blur", onPhoneInput);
        }
        if (zip){
          zip.removeEventListener("input", onZipInput);
          zip.removeEventListener("blur", onZipInput);
        }

        boaRadios.forEach(r=>{
          r.removeEventListener("change", onBasisChange);
        });

        if (boaOtherText){
          boaOtherText.removeEventListener("input", onOtherTextInput);
          boaOtherText.removeEventListener("change", onOtherTextInput);
          boaOtherText.removeEventListener("blur", onOtherTextInput);
        }

        allInputs.forEach(el=>{
          el.removeEventListener("input", onAnyChange);
          el.removeEventListener("change", onAnyChange);
          el.removeEventListener("blur", onAnyChange);
        });
      };
    };
  })();
</script>

</body>
</html>
