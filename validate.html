<!-- validate.html - ONLY USES CACHE FROM INDEX.HTML -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Validate Access Code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <script>
    (function() {
      const CACHE_KEY = "carbyne_valid_codes_cache";

      function normalize(v) {
        return (v ?? "").toString().trim();
      }

      function getCode() {
        const hash = (location.hash || "").replace(/^#/, "");
        const params = new URLSearchParams(hash);
        return normalize(params.get("code") || "");
      }

      function postResult(valid, code) {
        const payload = {
          type: "carbyne-validate",
          valid: !!valid,
          code: code || ""
        };

        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage(payload, "*");
          }
          if (window.opener) {
            window.opener.postMessage(payload, "*");
          }
        } catch (e) {
          console.error("Failed to post message:", e);
        }

        document.body.textContent = valid ? "Valid" : "Invalid";
      }

      function validate() {
        const code = getCode();

        if (!code) {
          postResult(false, "");
          return;
        }

        // Read ONLY from cache created by index.html
        try {
          const cached = localStorage.getItem(CACHE_KEY);
          
          if (!cached) {
            console.error("No cache found - index.html must be opened first");
            postResult(false, code);
            return;
          }

          const codes = JSON.parse(cached);
          
          if (!Array.isArray(codes)) {
            console.error("Invalid cache format");
            postResult(false, code);
            return;
          }

          // INSTANT validation from cache
          const needle = code.toLowerCase();
          const isValid = codes.includes(needle);
          postResult(isValid, code);

        } catch (error) {
          console.error("Validation error:", error);
          postResult(false, code);
        }
      }

      validate();
    })();
  </script>
</body>
</html>
