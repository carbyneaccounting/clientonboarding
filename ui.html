<!-- ui.html - WITH BUILT-IN INSTANT VALIDATION -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Client Onboarding - Carbyne Accounting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.cdnfonts.com/css/baron" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --carbyne-blue: #00305B;
      --carbyne-blue-2: #0A3D6F;
      --radius: 18px;
      --shadow: 0 28px 56px rgba(0, 0, 0, 0.30);
      --danger: #b91c1c;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, var(--carbyne-blue) 0%, var(--carbyne-blue-2) 50%, var(--carbyne-blue) 100%);
      position: relative;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .top-left-info {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #ffffff;
      z-index: 10;
    }

    .company-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .address {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.2px;
      line-height: 1.35;
      opacity: 0.98;
    }

    .container {
      width: min(1200px, 95vw);
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-family: 'Baron', sans-serif;
      font-size: 22px;
      color: #ffffff;
      font-weight: normal;
      margin-bottom: 14px;
    }

    .card {
      width: 100%;
      height: clamp(520px, 72vh, 860px);
      background: #ffffff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .top-section {
      padding: 18px 30px;
      border-bottom: 1px solid #e6e6e6;
      background: #ffffff;
      z-index: 2;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: #dedede;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--carbyne-blue) 0%, var(--carbyne-blue-2) 100%);
      border-radius: 999px;
      transition: width 0.25s ease;
    }

    .middle-section {
      flex: 1;
      padding: 26px 30px;
      overflow: auto;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.52) 0%, rgba(0, 0, 0, 0.42) 45%, rgba(0, 0, 0, 0.52) 100%),
        url("https://images.unsplash.com/photo-1519681393784-d120267933ba");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    #pageMount {
      width: 100%;
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bottom-section {
      padding: 18px 30px;
      border-top: 1px solid #e6e6e6;
      background: #ffffff;
      z-index: 2;
    }

    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .nav-button {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .nav-button.previous {
      background: #f0f0f0;
      color: #333;
    }

    .nav-button.previous:hover:not(:disabled) {
      opacity: 0.95;
      transform: translateY(-1px);
    }

    .nav-button.next {
      background: linear-gradient(90deg, var(--carbyne-blue) 0%, var(--carbyne-blue-2) 100%);
      color: #ffffff;
    }

    .nav-button.next:hover:not(:disabled) {
      opacity: 0.95;
      transform: translateY(-1px);
    }

    .nav-button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
    }

    .page-indicator {
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }

    .footer {
      position: absolute;
      bottom: 20px;
      left: 20px;
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      opacity: 0.95;
      z-index: 10;
    }

    /* Access Module Styles */
    .access-shell {
      width: min(740px, 92%);
      padding: 2px;
      border-radius: 22px;
      background: linear-gradient(135deg, var(--carbyne-blue) 0%, var(--carbyne-blue-2) 50%, var(--carbyne-blue) 100%);
      box-shadow: 0 28px 64px rgba(0, 0, 0, 0.28);
    }

    .access-card {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 20px;
      padding: 30px 30px 26px 30px;
    }

    .access-title {
      font-size: 18px;
      font-weight: 800;
      color: #111827;
      margin: 0 0 14px 0;
      text-align: left;
    }

    .access-label {
      font-size: 13px;
      font-weight: 800;
      color: #334155;
      margin: 0 0 8px 0;
      text-align: left;
      letter-spacing: 0.2px;
    }

    .access-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      border: 1px solid rgba(0, 0, 0, 0.18);
      border-radius: 12px;
      outline: none;
      margin: 0 0 16px 0;
      background: #ffffff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .access-input:focus {
      border-color: rgba(0, 48, 91, 0.75);
      box-shadow: 0 0 0 3px rgba(0, 48, 91, 0.18);
    }

    .access-input.error {
      border-color: var(--danger);
    }

    .access-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .access-submit {
      padding: 11px 22px;
      font-size: 14px;
      font-weight: 800;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.10);
      background: linear-gradient(90deg, var(--carbyne-blue) 0%, var(--carbyne-blue-2) 100%);
      color: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 132px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.14);
      transition: opacity 0.2s ease, box-shadow 0.2s ease;
    }

    .access-submit:hover:not(:disabled) {
      opacity: 0.95;
    }

    .access-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .inline-msg {
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.2px;
      display: none;
      white-space: nowrap;
      color: var(--danger);
    }

    .inline-msg.show {
      display: inline;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Page 2+ styling */
    .page-content {
      width: min(740px, 92%);
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      padding: 30px;
      color: #111827;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.18);
    }

    .page-content h2 {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 16px;
      color: var(--carbyne-blue);
    }

    .page-content p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
    }
  </style>
</head>

<body>
  <div class="top-left-info">
    <div class="company-name">Carbyne Accounting</div>
    <div class="address">
      734 West Main Street, Suite 106<br>
      Louisville, Kentucky 40202<br>
      (502) 632-9444 | Client@CarbyneAccounting.com
    </div>
  </div>

  <div class="container">
    <h1>Client Onboarding</h1>

    <div class="card">
      <div class="top-section">
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
      </div>

      <div class="middle-section">
        <div id="pageMount"></div>
      </div>

      <div class="bottom-section">
        <div class="navigation">
          <button class="nav-button previous" id="prevBtn">Previous</button>
          <span class="page-indicator" id="pageIndicator">Step 1 of 5</span>
          <button class="nav-button next" id="nextBtn">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Carbyne Accountingâ„¢ - Confidential &amp; Proprietary System</div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const TOTAL_PAGES = 5;
    const STORAGE_KEY = "carbyne_access_code";
    const CURRENT_PAGE_KEY = "carbyne_current_page";
    const CACHE_KEY = "carbyne_valid_codes_cache";
    const CACHE_TIMESTAMP_KEY = "carbyne_valid_codes_timestamp";
    const FILE_URL = "https://carbyneaccounting407-my.sharepoint.com/personal/drew_parker_carbyneaccounting_com/_layouts/15/download.aspx?share=IQAcTAjRA-l7TqHbBdGRxsEiAeJJGgMWq2HGDeAv6tGCUIQ";
    const TARGET_HEADER = "Unique Identifier";
    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

    // ============================================
    // STATE
    // ============================================
    let currentPage = 1;
    let isAccessValidated = false;
    let validCodesCache = null;
    let isFetchingCodes = false;

    // ============================================
    // ELEMENTS
    // ============================================
    const pageMount = document.getElementById("pageMount");
    const progressBar = document.getElementById("progressBar");
    const pageIndicator = document.getElementById("pageIndicator");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    // ============================================
    // VALIDATION FUNCTIONS
    // ============================================
    function normalize(v) {
      return (v ?? "").toString().trim();
    }

    function getCachedCodes() {
      if (validCodesCache) return validCodesCache;

      try {
        const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
        const now = Date.now();

        if (timestamp && (now - parseInt(timestamp)) < CACHE_DURATION) {
          const cached = localStorage.getItem(CACHE_KEY);
          if (cached) {
            validCodesCache = JSON.parse(cached);
            return validCodesCache;
          }
        }
      } catch (e) {
        console.error("Cache read error:", e);
      }
      return null;
    }

    function setCachedCodes(codes) {
      validCodesCache = codes;
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(codes));
        localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
      } catch (e) {
        console.error("Cache write error:", e);
      }
    }

    function findHeaderIndex(headers) {
      const lower = headers.map(h => normalize(h).toLowerCase());
      const target = TARGET_HEADER.toLowerCase();
      
      for (let i = 0; i < lower.length; i++) {
        if (lower[i] === target) return i;
      }
      
      return -1;
    }

    async function fetchValidCodes() {
      if (isFetchingCodes) {
        // Wait for existing fetch
        while (isFetchingCodes) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        return validCodesCache;
      }

      isFetchingCodes = true;

      try {
        const res = await fetch(FILE_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, { type: "array" });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {
          header: 1,
          raw: false,
          defval: ""
        });

        if (!rows || rows.length < 2) {
          throw new Error("No data found");
        }

        const headers = rows[0].map(v => normalize(v));
        const col = findHeaderIndex(headers);

        if (col < 0) {
          throw new Error("Column 'Unique Identifier' not found");
        }

        const validCodes = [];
        for (let r = 1; r < rows.length; r++) {
          const row = rows[r] || [];
          const cell = normalize(row[col] ?? "");
          if (cell) {
            validCodes.push(cell.toLowerCase());
          }
        }

        setCachedCodes(validCodes);
        return validCodes;

      } catch (error) {
        console.error("Fetch error:", error);
        throw error;
      } finally {
        isFetchingCodes = false;
      }
    }

    async function validateCode(code) {
      const needle = code.toLowerCase();

      // Check cache first
      let codes = getCachedCodes();

      if (codes && Array.isArray(codes)) {
        // INSTANT validation from cache!
        const isValid = codes.includes(needle);
        
        // Refresh cache in background
        fetchValidCodes().catch(() => {});
        
        return isValid;
      }

      // No cache - fetch from SharePoint
      try {
        codes = await fetchValidCodes();
        return codes.includes(needle);
      } catch (error) {
        return false;
      }
    }

    // ============================================
    // PAGE NAVIGATION
    // ============================================
    function init() {
      const accessCode = localStorage.getItem(STORAGE_KEY);
      isAccessValidated = !!accessCode;

      const savedPage = parseInt(localStorage.getItem(CURRENT_PAGE_KEY)) || 1;
      currentPage = isAccessValidated ? savedPage : 1;

      // Pre-load valid codes in background
      if (!getCachedCodes()) {
        fetchValidCodes().catch(() => {});
      }

      loadPage(currentPage);

      prevBtn.addEventListener("click", goToPreviousPage);
      nextBtn.addEventListener("click", goToNextPage);
    }

    function updateUI() {
      const progress = (currentPage / TOTAL_PAGES) * 100;
      progressBar.style.width = `${progress}%`;

      pageIndicator.textContent = `Step ${currentPage} of ${TOTAL_PAGES}`;

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === TOTAL_PAGES;

      localStorage.setItem(CURRENT_PAGE_KEY, currentPage);
    }

    function goToPreviousPage() {
      if (currentPage > 1) {
        currentPage--;
        loadPage(currentPage);
      }
    }

    function goToNextPage() {
      if (currentPage < TOTAL_PAGES) {
        currentPage++;
        loadPage(currentPage);
      }
    }

    function loadPage(pageNum) {
      pageMount.innerHTML = "";
      updateUI();

      if (pageNum === 1) {
        loadAccessModule();
      } else {
        if (!isAccessValidated) {
          currentPage = 1;
          loadAccessModule();
          return;
        }
        loadPageContent(pageNum);
      }
    }

    // ============================================
    // ACCESS MODULE
    // ============================================
    function loadAccessModule() {
      const accessHTML = `
        <div class="access-shell">
          <div class="access-card">
            <div class="access-title">Enter Access Code</div>

            <div class="access-label">Unique Identifier</div>
            <input
              type="text"
              class="access-input"
              id="accessCode"
              placeholder="Enter your Unique Identifier"
              autocomplete="off"
            >

            <div class="access-row">
              <button type="button" class="access-submit" id="submitCode">
                <span id="btnText">Submit</span>
              </button>
              <span class="inline-msg" id="inlineMsg">Invalid Access Code</span>
            </div>
          </div>
        </div>
      `;

      pageMount.innerHTML = accessHTML;
      initAccessModule();
    }

    function initAccessModule() {
      const input = document.getElementById("accessCode");
      const btn = document.getElementById("submitCode");
      const btnText = document.getElementById("btnText");
      const msg = document.getElementById("inlineMsg");

      function showInvalid(show, message = "Invalid Access Code") {
        if (show) {
          msg.classList.add("show");
          msg.textContent = message;
          input.classList.add("error");
        } else {
          msg.classList.remove("show");
          input.classList.remove("error");
        }
      }

      function setBusy(isBusy) {
        btn.disabled = !!isBusy;
        if (isBusy) {
          btnText.innerHTML = '<span class="spinner"></span>';
        } else {
          btnText.textContent = "Submit";
        }
      }

      async function submit() {
        showInvalid(false);

        const code = normalize(input.value);
        input.value = code;

        if (!code) {
          showInvalid(true, "Please enter a code");
          return;
        }

        setBusy(true);

        try {
          const isValid = await validateCode(code);

          if (isValid) {
            localStorage.setItem(STORAGE_KEY, code);
            isAccessValidated = true;
            goToNextPage();
          } else {
            showInvalid(true);
          }
        } catch (error) {
          showInvalid(true, "Validation error");
        } finally {
          setBusy(false);
        }
      }

      btn.addEventListener("click", submit);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submit();
      });

      const existing = localStorage.getItem(STORAGE_KEY);
      if (existing) {
        input.value = normalize(existing);
      }

      showInvalid(false);
      input.focus();
    }

    // ============================================
    // PAGE CONTENT
    // ============================================
    function loadPageContent(pageNum) {
      const content = document.createElement("div");
      content.className = "page-content";

      switch (pageNum) {
        case 2:
          content.innerHTML = `
            <h2>Welcome to Step 2</h2>
            <p>This is the second step of the onboarding process.</p>
            <p>Add your content here for page 2.</p>
          `;
          break;
        case 3:
          content.innerHTML = `
            <h2>Welcome to Step 3</h2>
            <p>This is the third step of the onboarding process.</p>
            <p>Add your content here for page 3.</p>
          `;
          break;
        case 4:
          content.innerHTML = `
            <h2>Welcome to Step 4</h2>
            <p>This is the fourth step of the onboarding process.</p>
            <p>Add your content here for page 4.</p>
          `;
          break;
        case 5:
          content.innerHTML = `
            <h2>Welcome to Step 5</h2>
            <p>This is the final step of the onboarding process.</p>
            <p>Add your content here for page 5.</p>
          `;
          break;
        default:
          content.innerHTML = `
            <h2>Page ${pageNum}</h2>
            <p>Content for page ${pageNum} goes here.</p>
          `;
      }

      pageMount.appendChild(content);
    }

    // ============================================
    // START APPLICATION
    // ============================================
    init();
  </script>
</body>
</html>
