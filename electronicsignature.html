<!-- electronicsignature.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Electronic Signature</title>

  <style>
    :root{
      --sig-blue:#00305B;
      --sig-blue-2:#0A3D6F;
      --sig-ink:#0f172a;
      --sig-muted:#475569;
      --sig-border:rgba(0,0,0,.10);
      --sig-card:rgba(255,255,255,.90);
      --sig-radius:14px;
      --sig-shadow:0 14px 30px rgba(0,0,0,.12);
      --sig-danger:#b91c1c;
      --sig-ok:#16a34a;
    }

    .sig-wrap{
      width:100%;
    }

    /* Make compact by default */
    .sig-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:12px;
    }

    .sig-h-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .sig-mark{
      width:34px;height:34px;border-radius:10px;
      background:rgba(0,48,91,.08);
      border:1px solid rgba(0,0,0,.06);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 18px rgba(0,0,0,.08);
      color:var(--sig-blue);
      flex:0 0 auto;
    }

    .sig-titlebox{
      min-width:0;
    }

    .sig-title{
      font-weight:950;
      color:var(--sig-ink);
      font-size:14px;
      line-height:1.1;
    }
    .sig-sub{
      font-weight:800;
      color:var(--sig-muted);
      font-size:11px;
      opacity:.90;
      margin-top:3px;
      letter-spacing:.15px;
    }

    .sig-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }

    .sig-btn{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      color:var(--sig-ink);
      font-weight:900;
      font-size:12px;
      padding:6px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:opacity .15s ease, transform .15s ease, box-shadow .15s ease;
      box-shadow:0 10px 18px rgba(0,0,0,.06);
      user-select:none;
    }
    .sig-btn:hover{opacity:.95;transform:translateY(-1px)}
    .sig-btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

    .sig-btn.primary{
      background:linear-gradient(90deg,var(--sig-blue) 0%, var(--sig-blue-2) 100%);
      color:#fff;
    }
    .sig-btn.danger{
      background:rgba(185,28,28,.08);
      border-color:rgba(185,28,28,.25);
      color:var(--sig-danger);
      box-shadow:none;
    }

    .sig-grid{
      display:grid;
      grid-template-columns:1.2fr .9fr;
      gap:12px;
    }

    @media (max-width: 880px){
      .sig-grid{grid-template-columns:1fr}
    }

    .sig-card{
      background:var(--sig-card);
      border:1px solid var(--sig-border);
      border-radius:var(--sig-radius);
      box-shadow:var(--sig-shadow);
      padding:12px;
    }

    .sig-card h3{
      font-size:12px;
      font-weight:950;
      color:var(--sig-ink);
      margin-bottom:8px;
    }

    .sig-tabs{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      align-items:center;
    }

    .sig-tab{
      font-size:11px;
      font-weight:950;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .sig-tab.active{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.18);
      color:#1d4ed8;
    }

    .sig-canvas-wrap{
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      background:#fff;
      overflow:hidden;
    }

    .sig-canvas-top{
      padding:10px;
      border-bottom:1px solid rgba(0,0,0,.08);
      font-weight:900;
      font-size:11px;
      color:var(--sig-muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }

    canvas{
      display:block;
      width:100%;
      height:140px; /* compact */
      background:#fff;
      cursor:crosshair;
    }

    .sig-controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px;
      border-top:1px solid rgba(0,0,0,.08);
      background:rgba(248,250,252,.7);
    }

    .sig-left-controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .sig-slider{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:11px;
      color:var(--sig-muted);
    }

    .sig-slider input[type="range"]{width:90px}

    .sig-state{
      font-size:11px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .sig-state.ok{color:var(--sig-ok)}
    .sig-state.bad{color:var(--sig-danger)}

    .sig-type-wrap{
      display:none;
    }
    .sig-type-wrap.active{display:block}

    .sig-type-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .sig-type-row input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      font-weight:900;
      font-size:13px;
      outline:none;
    }

    .sig-preview{
      border:1px dashed rgba(0,0,0,.18);
      border-radius:12px;
      padding:10px;
      background:rgba(255,255,255,.85);
      min-height:62px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .sig-preview img{
      max-width:100%;
      max-height:48px;
      display:block;
    }

    .sig-mini-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }

    .sig-stat{
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      background:#fff;
      padding:10px;
      min-height:56px;
    }
    .sig-stat .k{
      font-size:10px;
      font-weight:900;
      color:var(--sig-muted);
      opacity:.90;
      margin-bottom:4px;
    }
    .sig-stat .v{
      font-size:12px;
      font-weight:950;
      color:var(--sig-ink);
    }
  </style>
</head>

<body>
  <!-- IMPORTABLE TEMPLATE -->
  <template id="carbyne_electronic_signature">
    <div class="sig-wrap">
      <div class="sig-header-row">
        <div class="sig-h-left">
          <div class="sig-mark" aria-hidden="true">‚úç</div>
          <div class="sig-titlebox">
            <div class="sig-title">Create Your Signature</div>
            <div class="sig-sub">Draw or type, then adopt</div>
          </div>
        </div>

        <div class="sig-actions">
          <button class="sig-btn danger" type="button" id="sigClearAllBtn">Clear</button>
          <button class="sig-btn primary" type="button" id="sigAdoptBtn" disabled>Adopt</button>
        </div>
      </div>

      <div class="sig-grid">
        <div class="sig-card">
          <h3>Signature Input</h3>

          <div class="sig-tabs">
            <button class="sig-tab active" type="button" id="sigTabDraw">Draw</button>
            <button class="sig-tab" type="button" id="sigTabType">Type</button>
          </div>

          <!-- DRAW -->
          <div id="sigDrawWrap">
            <div class="sig-canvas-wrap">
              <div class="sig-canvas-top">
                <span>Draw</span>
                <button class="sig-btn" type="button" id="sigClearDrawBtn">Clear</button>
              </div>
              <canvas id="sigCanvas"></canvas>
              <div class="sig-controls">
                <div class="sig-left-controls">
                  <div class="sig-slider">
                    <span>Stroke</span>
                    <input id="sigStroke" type="range" min="1" max="10" value="3">
                  </div>
                  <div class="sig-state" id="sigDrawState">Empty</div>
                </div>
                <div style="font-size:11px;font-weight:900;color:var(--sig-muted);opacity:.85;">
                  Switching modes clears the other mode.
                </div>
              </div>
            </div>
          </div>

          <!-- TYPE -->
          <div class="sig-type-wrap" id="sigTypeWrap">
            <div class="sig-type-row">
              <input id="sigTypedName" type="text" placeholder="Type your name" autocomplete="name">
            </div>
            <div class="sig-controls" style="border:1px solid rgba(0,0,0,.10); border-radius:12px; background:rgba(248,250,252,.7);">
              <div class="sig-left-controls" style="justify-content:space-between; width:100%;">
                <div class="sig-state" id="sigTypeState">Empty</div>
                <button class="sig-btn" type="button" id="sigRenderTypeBtn">Render</button>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="sig-preview" id="sigTypePreview">
              <div style="font-size:11px;font-weight:950;color:var(--sig-muted);opacity:.85;">Render Empty</div>
            </div>

            <div style="height:10px"></div>

            <div style="font-size:11px;font-weight:900;color:var(--sig-muted);opacity:.85;">
              Switching modes clears the other mode.
            </div>
          </div>
        </div>

        <div class="sig-card">
          <h3>Adoption Status</h3>

          <div class="sig-mini-grid">
            <div class="sig-stat">
              <div class="k">Mode</div>
              <div class="v" id="sigModeStat">Draw</div>
            </div>
            <div class="sig-stat">
              <div class="k">Has signature</div>
              <div class="v" id="sigHasStat">No</div>
            </div>
            <div class="sig-stat">
              <div class="k">Adopt button</div>
              <div class="v" id="sigBtnStat">Disabled</div>
            </div>
            <div class="sig-stat">
              <div class="k">Last adopted</div>
              <div class="v" id="sigLastStat">None</div>
            </div>
          </div>

          <div class="sig-stat" style="margin-bottom:10px;">
            <div class="k">Adopted signature</div>
            <div class="sig-preview" style="margin-top:8px;" id="sigAdoptedPreview">
              <div style="font-size:11px;font-weight:950;color:var(--sig-muted);opacity:.85;" id="sigAdoptedEmptyText">No adopted signature</div>
            </div>
          </div>

          <div style="font-size:11px;font-weight:900;color:var(--sig-muted);opacity:.85;">
            Adopt stores the signature for use across onboarding steps in the same session.
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    // Mount function name MUST match: <template id="carbyne_electronic_signature"> + "_mount"
    window.carbyne_electronic_signature_mount = function ({ root, referenceNumber, storageKey }) {
      const KEY = "carbyne_adopted_signature_dataurl";
      const TIME_KEY = "carbyne_adopted_signature_time";

      const el = (id) => root.querySelector("#" + id);

      const tabDraw = el("sigTabDraw");
      const tabType = el("sigTabType");
      const drawWrap = el("sigDrawWrap");
      const typeWrap = el("sigTypeWrap");

      const canvas = el("sigCanvas");
      const ctx = canvas.getContext("2d");

      const stroke = el("sigStroke");
      const drawState = el("sigDrawState");
      const typeState = el("sigTypeState");
      const typedName = el("sigTypedName");
      const renderTypeBtn = el("sigRenderTypeBtn");
      const typePreview = el("sigTypePreview");

      const clearDrawBtn = el("sigClearDrawBtn");
      const clearAllBtn = el("sigClearAllBtn");
      const adoptBtn = el("sigAdoptBtn");

      const modeStat = el("sigModeStat");
      const hasStat = el("sigHasStat");
      const btnStat = el("sigBtnStat");
      const lastStat = el("sigLastStat");

      const adoptedPreview = el("sigAdoptedPreview");
      const adoptedEmptyText = el("sigAdoptedEmptyText");

      let mode = "draw";
      let isDrawing = false;
      let hasDraw = false;
      let hasType = false;
      let typedDataUrl = "";

      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.max(1, Math.floor(rect.width * dpr));
        canvas.height = Math.max(1, Math.floor(rect.height * dpr));
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.strokeStyle = "#0f172a";
        ctx.lineWidth = parseInt(stroke.value, 10) || 3;
        clearCanvas();
        hasDraw = false;
        updateStates();
      }

      function clearCanvas(){
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);
      }

      function setMode(next){
        mode = next;
        modeStat.textContent = next === "draw" ? "Draw" : "Type";

        if (next === "draw"){
          tabDraw.classList.add("active");
          tabType.classList.remove("active");
          drawWrap.style.display = "block";
          typeWrap.classList.remove("active");
          clearType();
        } else {
          tabType.classList.add("active");
          tabDraw.classList.remove("active");
          drawWrap.style.display = "none";
          typeWrap.classList.add("active");
          clearDraw();
        }
        updateStates();
      }

      function clearDraw(){
        clearCanvas();
        hasDraw = false;
        updateStates();
      }

      function clearType(){
        typedName.value = "";
        typedDataUrl = "";
        hasType = false;
        typePreview.innerHTML = '<div style="font-size:11px;font-weight:950;color:var(--sig-muted);opacity:.85;">Render Empty</div>';
        updateStates();
      }

      function updateStates(){
        ctx.lineWidth = parseInt(stroke.value, 10) || 3;

        const has = (mode === "draw") ? hasDraw : hasType;

        drawState.textContent = hasDraw ? "Ready" : "Empty";
        drawState.className = "sig-state " + (hasDraw ? "ok" : "bad");

        typeState.textContent = hasType ? "Ready" : "Empty";
        typeState.className = "sig-state " + (hasType ? "ok" : "bad");

        hasStat.textContent = has ? "Yes" : "No";
        adoptBtn.disabled = !has;
        btnStat.textContent = adoptBtn.disabled ? "Disabled" : "Enabled";
      }

      function getDrawDataUrl(){
        const rect = canvas.getBoundingClientRect();
        const tmp = document.createElement("canvas");
        tmp.width = Math.max(1, Math.floor(rect.width));
        tmp.height = Math.max(1, Math.floor(rect.height));
        const tctx = tmp.getContext("2d");
        tctx.drawImage(canvas, 0, 0, rect.width, rect.height);
        return tmp.toDataURL("image/png");
      }

      function renderTyped(){
        const name = (typedName.value || "").trim();
        if (!name){
          typedDataUrl = "";
          hasType = false;
          typePreview.innerHTML = '<div style="font-size:11px;font-weight:950;color:var(--sig-muted);opacity:.85;">Render Empty</div>';
          updateStates();
          return;
        }

        const tmp = document.createElement("canvas");
        tmp.width = 900;
        tmp.height = 160;
        const tctx = tmp.getContext("2d");
        tctx.clearRect(0,0,tmp.width,tmp.height);

        // signature-like font stack
        tctx.fillStyle = "#0f172a";
        tctx.font = "72px \"Segoe Script\", \"Brush Script MT\", \"Comic Sans MS\", cursive";
        tctx.textBaseline = "middle";
        tctx.fillText(name, 24, tmp.height/2);

        typedDataUrl = tmp.toDataURL("image/png");
        hasType = true;
        typePreview.innerHTML = "";
        const img = new Image();
        img.alt = "Typed signature preview";
        img.src = typedDataUrl;
        typePreview.appendChild(img);
        updateStates();
      }

      function adopt(){
        // Clear old adopted signature first, then set new one
        localStorage.removeItem(KEY);
        localStorage.removeItem(TIME_KEY);

        const dataUrl = (mode === "draw") ? getDrawDataUrl() : typedDataUrl;
        if (!dataUrl) return;

        localStorage.setItem(KEY, dataUrl);
        localStorage.setItem(TIME_KEY, new Date().toISOString());
        paintAdopted();
        updateStates();
      }

      function paintAdopted(){
        const dataUrl = localStorage.getItem(KEY) || "";
        const ts = localStorage.getItem(TIME_KEY) || "";

        adoptedPreview.innerHTML = "";
        if (!dataUrl){
          adoptedPreview.appendChild(adoptedEmptyText);
          lastStat.textContent = "None";
          return;
        }

        const img = new Image();
        img.alt = "Adopted signature";
        img.src = dataUrl;
        adoptedPreview.appendChild(img);

        if (ts){
          const d = new Date(ts);
          const mm = String(d.getMonth()+1).padStart(2,"0");
          const dd = String(d.getDate()).padStart(2,"0");
          const yyyy = d.getFullYear();
          const hh = String(d.getHours()).padStart(2,"0");
          const mi = String(d.getMinutes()).padStart(2,"0");
          lastStat.textContent = `${mm}/${dd}/${yyyy} ${hh}:${mi}`;
        } else {
          lastStat.textContent = "Saved";
        }
      }

      // Drawing events
      function getPos(evt){
        const r = canvas.getBoundingClientRect();
        const x = (evt.touches ? evt.touches[0].clientX : evt.clientX) - r.left;
        const y = (evt.touches ? evt.touches[0].clientY : evt.clientY) - r.top;
        return { x, y };
      }

      let last = null;

      function start(evt){
        evt.preventDefault();
        isDrawing = true;
        last = getPos(evt);
      }

      function move(evt){
        if (!isDrawing) return;
        evt.preventDefault();
        const p = getPos(evt);
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        last = p;
        hasDraw = true;
        updateStates();
      }

      function end(evt){
        if (!isDrawing) return;
        evt.preventDefault();
        isDrawing = false;
        last = null;
      }

      // Wire up
      tabDraw.addEventListener("click", ()=>setMode("draw"));
      tabType.addEventListener("click", ()=>setMode("type"));

      stroke.addEventListener("input", updateStates);
      clearDrawBtn.addEventListener("click", clearDraw);

      clearAllBtn.addEventListener("click", ()=>{
        clearDraw();
        clearType();
        localStorage.removeItem(KEY);
        localStorage.removeItem(TIME_KEY);
        paintAdopted();
      });

      adoptBtn.addEventListener("click", adopt);

      renderTypeBtn.addEventListener("click", renderTyped);
      typedName.addEventListener("keydown", (e)=>{ if (e.key === "Enter") renderTyped(); });

      // Canvas pointer/mouse/touch
      canvas.addEventListener("mousedown", start);
      window.addEventListener("mousemove", move);
      window.addEventListener("mouseup", end);

      canvas.addEventListener("touchstart", start, { passive:false });
      canvas.addEventListener("touchmove", move, { passive:false });
      canvas.addEventListener("touchend", end, { passive:false });

      // Init
      typeWrap.classList.remove("active");
      drawWrap.style.display = "block";
      setMode("draw");

      // Adopted preview
      paintAdopted();

      // Resize after inserted into DOM
      setTimeout(resizeCanvas, 0);
      window.addEventListener("resize", resizeCanvas);

      // Return unmount
      return function unmount(){
        window.removeEventListener("resize", resizeCanvas);
        window.removeEventListener("mousemove", move);
        window.removeEventListener("mouseup", end);
      };
    };
  </script>
</body>
</html>
