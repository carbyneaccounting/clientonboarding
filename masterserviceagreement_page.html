<!-- masterserviceagreement_page.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Master Service Agreement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<template id="carbyne_masterserviceagreement_page">
  <style>
    *{box-sizing:border-box}

    .msa-wrap{width:100%}
    .msa-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:0 2px 7px;margin-bottom:7px}
    .msa-titlebox{display:flex;flex-direction:column;gap:4px}
    .msa-title{margin:0;font-size:18px;font-weight:950;color:#0b2f4e;letter-spacing:.2px}
    .msa-sub{margin:0;font-size:12px;font-weight:900;color:#334155;opacity:.85}

    .msa-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .msa-pill{
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      color:#0f172a;
      font-weight:900;
      font-size:11px;
      padding:7px 11px;
      border-radius:999px;
      cursor:pointer;
      transition:all .12s ease;
      white-space:nowrap;
      user-select:none;
    }
    .msa-pill.primary{background:rgba(0,48,91,.08);border-color:rgba(0,48,91,.18);color:#00305B}
    .msa-pill:disabled{opacity:.55;cursor:not-allowed}
    .msa-pill:hover:not(:disabled){transform:translateY(-1px);opacity:.96}

    .msa-card{background:#fff;border:1px solid rgba(0,0,0,.10);border-radius:10px;box-shadow:0 6px 13px rgba(2,6,23,.08);overflow:hidden}
    .msa-card-h{padding:8px 10px;border-bottom:1px solid rgba(0,0,0,.08);font-size:11px;font-weight:950;color:#0f172a;opacity:.90;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .msa-status{font-size:10px;font-weight:900;color:#0f172a;opacity:.70;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .msa-body{padding:10px}

    .msa-viewer{
      width:100%;
      height:520px;
      border:1px solid rgba(0,0,0,.14);
      border-radius:8px;
      overflow:hidden;
      background:#f8fafc;
    }
    .msa-iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
      background:#fff;
    }

    .msa-signbar{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .msa-hint{
      margin-right:auto;
      font-size:11px;
      font-weight:900;
      color:#334155;
      opacity:.82;
    }

    @media (max-width:900px){
      .msa-viewer{height:60vh}
    }
  </style>

  <div class="msa-wrap" id="msaRoot">
    <div class="msa-header">
      <div class="msa-titlebox">
        <h2 class="msa-title">Master Service Agreement</h2>
        <p class="msa-sub">Review the agreement below, then electronically sign.</p>
      </div>
      <div class="msa-actions">
        <button class="msa-pill" id="msaReload" type="button">Reload</button>
        <button class="msa-pill primary" id="msaBuild" type="button">Build PDF</button>
      </div>
    </div>

    <div class="msa-card">
      <div class="msa-card-h">
        <span>Agreement Viewer</span>
        <span class="msa-status" id="msaStatus">Idle</span>
      </div>
      <div class="msa-body">
        <div class="msa-viewer">
          <iframe class="msa-iframe" id="msaFrame" title="Master Service Agreement"></iframe>
        </div>

        <div class="msa-signbar">
          <div class="msa-hint">You can scroll within the agreement viewer.</div>
          <button class="msa-pill primary" id="msaSignBtn" type="button">Electronically Sign</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  (function(){
    const DOC_ID = "master_service_agreement";
    const AGREEMENT_TXT_URL = "https://raw.githubusercontent.com/carbyneaccounting/clientonboarding/refs/heads/main/MasterServiceAgreement.txt";
    const ARIALN_TTF_URL = "https://raw.githubusercontent.com/carbyneaccounting/clientonboarding/main/ARIALN.TTF";

    function normalize(v){ return (v ?? "").toString().trim(); }

    function stamp(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const yy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return mm + "/" + dd + "/" + yy + " " + hh + ":" + mi;
    }

    function bytesToB64(bytes){
      let s = "";
      const chunk = 0x8000;
      for (let i=0;i<bytes.length;i+=chunk){
        s += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
      }
      return btoa(s);
    }

    function wrapText(font, text, fontSize, maxWidth){
      const words = (text || "").split(/\s+/).filter(Boolean);
      const lines = [];
      let cur = "";

      for (const w of words){
        const test = cur ? (cur + " " + w) : w;
        const width = font.widthOfTextAtSize(test, fontSize);
        if (width <= maxWidth){
          cur = test;
        } else {
          if (cur) lines.push(cur);
          cur = w;
        }
      }
      if (cur) lines.push(cur);

      return lines.length ? lines : [""];
    }

    function isRomanHeading(line){
      const s = normalize(line);
      return /^[IVXLCDM]+\.\s+/.test(s);
    }

    function isTopTitle(line){
      const s = normalize(line);
      return s.toLowerCase() === "master service agreement" || s.toLowerCase() === "master services agreement";
    }

    function isSectionLabel(line){
      const s = normalize(line);
      if (!s) return false;
      if (isTopTitle(s)) return false;
      return isRomanHeading(s);
    }

    function isParagraphStart(line){
      const s = normalize(line);
      if (!s) return false;
      if (isSectionLabel(s)) return false;
      return true;
    }

    function boldDraw(page, font, text, x, y, size){
      page.drawText(text, { x, y, size, font });
      page.drawText(text, { x: x + 0.35, y, size, font });
    }

    async function fetchText(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }

    async function fetchBytes(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const ab = await res.arrayBuffer();
      return new Uint8Array(ab);
    }

    async function buildMSAPdfBytes(referenceNumber){
      const lib = window.PDFLib;
      if (!lib || !lib.PDFDocument) throw new Error("PDFLib unavailable");

      const { PDFDocument, StandardFonts } = lib;

      const [txt, ttfBytes] = await Promise.all([
        fetchText(AGREEMENT_TXT_URL),
        fetchBytes(ARIALN_TTF_URL)
      ]);

      const pdfDoc = await PDFDocument.create();

      const arialN = await pdfDoc.embedFont(ttfBytes, { subset: true });
      const helv = await pdfDoc.embedFont(StandardFonts.Helvetica);

      const PAGE_W = 612;
      const PAGE_H = 792;

      const marginX = 72;
      const topMargin = 64;
      const bottomMargin = 64;

      const headerY = PAGE_H - 42;
      const footerY = 26;

      const bodyTopY = PAGE_H - topMargin;
      const bodyBottomY = bottomMargin + 18;

      const bodyMaxW = PAGE_W - (marginX * 2);

      const baseSize = 10;
      const headingSize = 10;
      const titleSize = 10;

      const leading = 20;        // double-space (10pt * 2)
      const paraGap = 20;        // one blank line (also 20)
      const sectionGap = 20;     // one blank line

      const firmHeaderLeft = "Carbyne Accounting";
      const footerCenter = "Confidential & Proprietary";

      const rawLines = (txt || "").replace(/\r/g, "").split("\n");
      const lines = rawLines.map(l => l.replace(/\t/g, " ").trimRight());

      const blocks = [];
      for (let i=0;i<lines.length;i++){
        const s = normalize(lines[i]);
        if (!s) continue;

        if (isTopTitle(s)){
          blocks.push({ type:"title", text:"Master Service Agreement" });
          continue;
        }

        if (isSectionLabel(s)){
          blocks.push({ type:"section", text:s });
          continue;
        }

        blocks.push({ type:"para", text:s });
      }

      let page = null;
      let y = 0;
      let pageNo = 0;

      function newPage(){
        page = pdfDoc.addPage([PAGE_W, PAGE_H]);
        pageNo++;

        // Header
        boldDraw(page, helv, firmHeaderLeft, marginX, headerY, 10);

        const ref = "Reference: " + (referenceNumber || "");
        const refW = helv.widthOfTextAtSize(ref, 10);
        boldDraw(page, helv, ref, PAGE_W - marginX - refW, headerY, 10);

        // Footer
        const cW = helv.widthOfTextAtSize(footerCenter, 10);
        page.drawText(footerCenter, { x: (PAGE_W - cW)/2, y: footerY, size: 10, font: helv });

        const pText = "Page " + pageNo;
        const pW = helv.widthOfTextAtSize(pText, 10);
        page.drawText(pText, { x: PAGE_W - marginX - pW, y: footerY, size: 10, font: helv });

        y = bodyTopY;
      }

      function needSpace(h){
        return (y - h) < bodyBottomY;
      }

      function drawLine(font, text, size){
        if (needSpace(leading)) newPage();
        page.drawText(text, { x: marginX, y: y, size, font });
        y -= leading;
      }

      function drawBoldLine(font, text, size){
        if (needSpace(leading)) newPage();
        boldDraw(page, font, text, marginX, y, size);
        y -= leading;
      }

      function gap(amount){
        if (needSpace(amount)) newPage();
        y -= amount;
      }

      newPage();

      for (const b of blocks){
        if (b.type === "title"){
          drawBoldLine(arialN, b.text, titleSize);
          gap(sectionGap);
          continue;
        }

        if (b.type === "section"){
          drawBoldLine(arialN, b.text, headingSize);
          gap(sectionGap);
          continue;
        }

        if (b.type === "para"){
          const t = normalize(b.text);

          // Keep checkbox line intact if present
          if (/^\s*/.test(t) || /^□\s*/.test(t)){
            drawLine(arialN, t, baseSize);
            gap(paraGap);
            continue;
          }

          const wrapped = wrapText(arialN, t, baseSize, bodyMaxW);
          for (const ln of wrapped) drawLine(arialN, ln, baseSize);
          gap(paraGap);
          continue;
        }
      }

      const outBytes = await pdfDoc.save();
      return outBytes;
    }

    function setStatus(root, msg){
      const el = root.querySelector("#msaStatus");
      if (el) el.textContent = msg;
    }

    function showPdfInFrame(root, bytes){
      const frame = root.querySelector("#msaFrame");
      if (!frame) return;

      const blob = new Blob([bytes], { type:"application/pdf" });
      const url = URL.createObjectURL(blob);

      const prev = frame.getAttribute("data-msa-url") || "";
      frame.setAttribute("data-msa-url", url);
      frame.src = url;

      if (prev){
        try{ URL.revokeObjectURL(prev); } catch {}
      }
    }

    window.carbyne_masterserviceagreement_page_mount = function(args){
      const root = (args && args.root) ? args.root : document;
      const referenceNumber = (args && args.referenceNumber) ? args.referenceNumber : "";

      const reloadBtn = root.querySelector("#msaReload");
      const buildBtn = root.querySelector("#msaBuild");
      const signBtn = root.querySelector("#msaSignBtn");

      let destroyed = false;

      async function buildAndRender(){
        setStatus(root, "Building PDF...");
        if (buildBtn) buildBtn.disabled = true;

        try{
          const bytes = await buildMSAPdfBytes(referenceNumber);
          if (destroyed) return;

          showPdfInFrame(root, bytes);

          const b64 = bytesToB64(bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes));

          window.dispatchEvent(new CustomEvent("carbyne:pdfdoc:upsert", {
            detail: {
              id: DOC_ID,
              title: "Master Service Agreement",
              b64: b64,
              meta: {
                referenceNumber: referenceNumber || "",
                createdAt: stamp()
              }
            }
          }));

          setStatus(root, "Loaded");
        } catch (e){
          setStatus(root, "Unable to load agreement.");
          try{ console.error("MSA build error:", e); } catch {}
        } finally {
          if (buildBtn) buildBtn.disabled = false;
        }
      }

      function onReload(){
        buildAndRender();
      }

      function onBuild(){
        buildAndRender();
      }

      function onSign(){
        window.dispatchEvent(new CustomEvent("carbyne:agreement:sign", {
          detail: { id: DOC_ID, title: "Master Service Agreement" }
        }));
      }

      if (reloadBtn) reloadBtn.addEventListener("click", onReload);
      if (buildBtn) buildBtn.addEventListener("click", onBuild);
      if (signBtn) signBtn.addEventListener("click", onSign);

      // Auto-build on mount
      buildAndRender();

      return function unmount(){
        destroyed = true;

        if (reloadBtn) reloadBtn.replaceWith(reloadBtn.cloneNode(true));
        if (buildBtn) buildBtn.replaceWith(buildBtn.cloneNode(true));
        if (signBtn) signBtn.replaceWith(signBtn.cloneNode(true));

        const frame = root.querySelector("#msaFrame");
        if (frame){
          const prev = frame.getAttribute("data-msa-url") || "";
          frame.removeAttribute("data-msa-url");
          frame.src = "about:blank";
          if (prev){
            try{ URL.revokeObjectURL(prev); } catch {}
          }
        }
      };
    };
  })();
</script>

</body>
</html>
