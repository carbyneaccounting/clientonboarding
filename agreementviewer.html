<!-- agreementviewer.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Agreement Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<template id="carbyne_agreement_viewer">
  <style>
    .av-wrap{width:100%;max-width:980px}

    .av-top{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:4px 2px 0}
    .av-h2{margin:0;font-size:22px;font-weight:950;color:#0b2f4e;letter-spacing:.2px}

    .av-card{
      margin-top:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.12);
      border-radius:14px;
      box-shadow:0 10px 20px rgba(2,6,23,.08);
      overflow:hidden;
    }

    .av-dochead{
      padding:12px 14px;
      border-bottom:1px solid rgba(0,0,0,.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background:#fff;
    }

    .av-docmeta{display:flex;flex-direction:column;gap:4px}
    .av-title{
      font-size:14px;
      font-weight:950;
      color:#0f172a;
      letter-spacing:.2px;
      margin:0;
      line-height:1.2;
    }
    .av-sub{
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      opacity:.68;
      letter-spacing:.2px;
      margin:0;
      line-height:1.2;
      white-space:nowrap;
    }

    .av-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .av-pill{
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      color:#0f172a;
      font-weight:900;
      font-size:11px;
      padding:7px 11px;
      border-radius:999px;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease, box-shadow .12s ease, background-color .12s ease;
      white-space:nowrap;
      box-shadow:0 8px 16px rgba(2,6,23,.06);
    }
    .av-pill:hover{transform:translateY(-1px);opacity:.97;box-shadow:0 10px 20px rgba(2,6,23,.08)}
    .av-pill:active{transform:translateY(0);opacity:.95}

    .av-pill.primary{
      background:rgba(0,48,91,.06);
      border-color:rgba(0,48,91,.20);
      color:#00305B;
    }

    .av-pill.danger{
      background:rgba(185,28,28,.06);
      border-color:rgba(185,28,28,.20);
      color:#b91c1c;
    }

    .av-pill:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:0 8px 16px rgba(2,6,23,.04);
    }

    .av-body{padding:0;background:#fff}
    .av-scroll{
      height:420px;
      overflow:auto;
      padding:18px 18px 20px;
      background:#fff;
    }

    .av-scroll::-webkit-scrollbar{width:12px}
    .av-scroll::-webkit-scrollbar-track{background:rgba(0,0,0,.08)}
    .av-scroll::-webkit-scrollbar-thumb{
      background:rgba(0,48,91,.40);
      border-radius:999px;
      border:3px solid rgba(255,255,255,.70);
    }
    .av-scroll{scrollbar-width:auto;scrollbar-color:rgba(0,48,91,.40) rgba(0,0,0,.08)}

    .av-doc{
      max-width:900px;
      margin:0 auto;
      background:#fff;
      color:#0f172a;
      font-family:"Times New Roman", Times, serif;
    }

    .av-pre{
      margin:0;
      font-size:14px;
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
    }

    .av-foot{
      padding:10px 14px;
      border-top:1px solid rgba(0,0,0,.10);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:#0f172a;
      opacity:.60;
      font-size:11px;
      font-weight:900;
      letter-spacing:.2px;
      user-select:none;
    }

    .av-status{
      font-size:12px;
      font-weight:950;
      color:#0f172a;
      opacity:.72;
      letter-spacing:.2px;
      padding:10px 14px;
      border-bottom:1px solid rgba(0,0,0,.08);
      background:rgba(0,0,0,.02);
      display:none;
    }
    .av-status.show{display:block}
    .av-status.bad{color:#b91c1c;opacity:1;background:rgba(185,28,28,.06);border-bottom-color:rgba(185,28,28,.16)}

    @media (max-width:820px){
      .av-scroll{height:460px}
      .av-sub{white-space:normal}
      .av-actions{width:100%;justify-content:flex-start}
      .av-dochead{flex-direction:column;align-items:flex-start}
    }
  </style>

  <div class="av-wrap" id="avRoot">
    <div class="av-top">
      <h2 class="av-h2" id="avPageTitle">Agreement</h2>
      <div></div>
    </div>

    <div class="av-card">
      <div class="av-dochead">
        <div class="av-docmeta">
          <p class="av-title" id="avDocTitle">Agreement</p>
          <p class="av-sub" id="avRef">Reference Number: —</p>
        </div>

        <div class="av-actions">
          <button class="av-pill" id="avReload" type="button">Reload</button>
          <button class="av-pill danger" id="avCopy" type="button">Copy Text</button>
          <button class="av-pill primary" id="avMarkRead" type="button">Mark Read</button>
        </div>
      </div>

      <div class="av-status" id="avStatus"></div>

      <div class="av-body">
        <div class="av-scroll" id="avScroll">
          <div class="av-doc">
            <pre class="av-pre" id="avText">Loading…</pre>
          </div>
        </div>
      </div>

      <div class="av-foot">
        <div id="avFootLeft">Confidential</div>
        <div id="avFootRight">Page 1 of 1</div>
      </div>
    </div>
  </div>
</template>

<script>
  (function(){
    const TEXT_CACHE_PREFIX = "carbyne_agreement_text_cache::";
    const READ_PREFIX = "carbyne_agreement_read::";

    function normalize(v){ return (v ?? "").toString().trim(); }

    function setStatus(root, text, isBad){
      const el = root.querySelector("#avStatus");
      if (!el) return;
      if (!text){
        el.classList.remove("show","bad");
        el.textContent = "";
        return;
      }
      el.textContent = text;
      el.classList.add("show");
      if (isBad) el.classList.add("bad"); else el.classList.remove("bad");
    }

    function cacheKey(url){
      return TEXT_CACHE_PREFIX + btoa(unescape(encodeURIComponent(url || "")));
    }

    function readKey(id){
      return READ_PREFIX + normalize(id || "");
    }

    function getCachedText(url){
      try{
        const k = cacheKey(url);
        const raw = localStorage.getItem(k);
        if (!raw) return "";
        return raw;
      } catch {
        return "";
      }
    }

    function setCachedText(url, text){
      try{
        const k = cacheKey(url);
        localStorage.setItem(k, text || "");
      } catch {}
    }

    async function fetchAgreementText(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }

    function applyTokens(text, tokens){
      let out = (text ?? "").toString();
      const t = (tokens && typeof tokens === "object") ? tokens : {};
      Object.keys(t).forEach(k=>{
        const v = (t[k] ?? "").toString();
        const needle = "{{" + k + "}}";
        out = out.split(needle).join(v);
      });
      return out;
    }

    function isMarkedRead(id){
      try{
        return localStorage.getItem(readKey(id)) === "1";
      } catch {
        return false;
      }
    }

    function setMarkedRead(id, on){
      try{
        localStorage.setItem(readKey(id), on ? "1" : "0");
      } catch {}
    }

    function updateMarkReadBtn(root, id){
      const btn = root.querySelector("#avMarkRead");
      if (!btn) return;
      const on = isMarkedRead(id);
      btn.textContent = on ? "Read" : "Mark Read";
      btn.disabled = on;
    }

    function setFooterPages(root, page, total){
      const right = root.querySelector("#avFootRight");
      if (right) right.textContent = "Page " + String(page || 1) + " of " + String(total || 1);
    }

    function setFooterLeft(root, text){
      const left = root.querySelector("#avFootLeft");
      if (left) left.textContent = normalize(text) || "Confidential";
    }

    window.carbyne_agreement_viewer_mount = function(args){
      const root = args && args.root ? args.root : document;

      const agreementId = normalize(args && args.agreementId) || "agreement";
      const agreementTitle = normalize(args && args.agreementTitle) || "Agreement";
      const agreementUrl = normalize(args && args.agreementUrl) || "";
      const referenceNumber = normalize(args && args.referenceNumber) || "";
      const tokens = (args && typeof args.tokens === "object" && args.tokens) ? args.tokens : {};
      const footerLeft = normalize(args && args.footerLeft) || "Confidential";

      const pageTitleEl = root.querySelector("#avPageTitle");
      const docTitleEl = root.querySelector("#avDocTitle");
      const refEl = root.querySelector("#avRef");
      const textEl = root.querySelector("#avText");
      const reloadBtn = root.querySelector("#avReload");
      const copyBtn = root.querySelector("#avCopy");
      const markReadBtn = root.querySelector("#avMarkRead");

      if (pageTitleEl) pageTitleEl.textContent = agreementTitle;
      if (docTitleEl) docTitleEl.textContent = agreementTitle;
      if (refEl) refEl.textContent = "Reference Number: " + (referenceNumber || "—");
      setFooterLeft(root, footerLeft);
      setFooterPages(root, 1, 1);
      updateMarkReadBtn(root, agreementId);

      let alive = true;

      async function loadText(useCacheFirst){
        if (!textEl) return;

        setStatus(root, "", false);

        if (!agreementUrl){
          textEl.textContent = "Agreement source not configured.";
          setStatus(root, "Missing agreement URL.", true);
          return;
        }

        if (useCacheFirst){
          const cached = getCachedText(agreementUrl);
          if (cached){
            textEl.textContent = applyTokens(cached, tokens);
          }
        } else {
          textEl.textContent = "Loading…";
        }

        try{
          const txt = await fetchAgreementText(agreementUrl);
          if (!alive) return;
          setCachedText(agreementUrl, txt);
          textEl.textContent = applyTokens(txt, tokens);
        } catch (e){
          if (!alive) return;
          const cached = getCachedText(agreementUrl);
          if (cached){
            textEl.textContent = applyTokens(cached, tokens);
            setStatus(root, "Unable to fetch latest agreement. Showing cached copy.", true);
          } else {
            textEl.textContent = "Unable to load agreement text.";
            setStatus(root, "Unable to load agreement.", true);
          }
        }
      }

      function onReload(){
        loadText(false);
      }

      async function onCopy(){
        const t = (textEl && textEl.textContent) ? textEl.textContent : "";
        if (!t) return;

        try{
          await navigator.clipboard.writeText(t);
          setStatus(root, "Copied.", false);
          setTimeout(()=>{ if (alive) setStatus(root, "", false); }, 1200);
        } catch {
          try{
            const ta = document.createElement("textarea");
            ta.value = t;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
            setStatus(root, "Copied.", false);
            setTimeout(()=>{ if (alive) setStatus(root, "", false); }, 1200);
          } catch {
            setStatus(root, "Copy failed.", true);
          }
        }
      }

      function onMarkRead(){
        if (isMarkedRead(agreementId)) return;
        setMarkedRead(agreementId, true);
        updateMarkReadBtn(root, agreementId);
        try{
          window.dispatchEvent(new CustomEvent("carbyne:agreement:read", {
            detail: { id: agreementId, title: agreementTitle, referenceNumber: referenceNumber || "" }
          }));
        } catch {}
      }

      if (reloadBtn) reloadBtn.addEventListener("click", onReload);
      if (copyBtn) copyBtn.addEventListener("click", onCopy);
      if (markReadBtn) markReadBtn.addEventListener("click", onMarkRead);

      loadText(true);

      return function unmount(){
        alive = false;
        if (reloadBtn) reloadBtn.removeEventListener("click", onReload);
        if (copyBtn) copyBtn.removeEventListener("click", onCopy);
        if (markReadBtn) markReadBtn.removeEventListener("click", onMarkRead);
      };
    };
  })();
</script>

</body>
</html>
